# PM-007: 增值税计算逻辑错误

## 元信息
- **ID**: PM-007
- **修复Commit**: b3753de
- **影响范围**: 成本计算、系统配置
- **根因类别**: `LOGIC`

## 问题描述
增值税 (VAT) 计算存在逻辑错误，用户手动输入税率导致数值不规范和计算混乱。

## 根因分析
- **直接原因**: 允许用户自由输入增值税率，输入值不规范
- **深层原因**: 
  1. 增值税率应为固定选项（13%、9%、6%、0%）
  2. 计算公式中税率格式不统一（百分比 vs 小数）
  3. 系统配置未做输入验证
- **涉及文件**: 
  - `backend/models/StandardCost.js`
  - `backend/models/SystemConfig.js`
  - `backend/utils/costCalculator.js`
  - `frontend/src/views/config/SystemConfig.vue`
  - `frontend/src/views/cost/CostAdd.vue`

## 触发条件 ⚠️ 关键
```yaml
patterns:
  - type: code_pattern
    regex: "vat.*input|tax.*input|<el-input.*税"
    description: "税率使用 input 而非 select 可能导致非法输入"
  - type: code_pattern
    regex: "vat_rate.*[*/]\\s*100|tax.*[*/]\\s*100"
    description: "税率百分比与小数转换易出错"
  - type: scenario
    description: "涉及税率、费率等固定选项，应使用下拉选择"
  - type: keyword
    words: ["vat", "增值税", "税率", "tax_rate", "13%", "选项"]
```

## 修复方案
1. 将增值税率改为下拉选项：
```vue
<el-select v-model="vatRate">
  <el-option label="13%" :value="0.13" />
  <el-option label="9%" :value="0.09" />
  <el-option label="6%" :value="0.06" />
  <el-option label="0%" :value="0" />
</el-select>
```
2. 后端验证税率必须在合法范围内
3. 统一使用小数格式存储（0.13 而非 13）

## 预防检查清单
- [ ] 税率、费率等使用枚举/选项，禁止自由输入
- [ ] 百分比统一使用小数存储（0.13）
- [ ] 系统配置项需有合法值校验
- [ ] 计算公式中税率格式需统一

## 相关问题
- 模式: LOGIC - 配置项验证
