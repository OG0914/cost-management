# PM-005: 前端利润区间计算错误

## 元信息
- **ID**: PM-005
- **修复Commit**: 95f7ffd
- **影响范围**: 成本详情页、标准成本页
- **根因类别**: `LOGIC`

## 问题描述
成本详情页查看模式下，利润区间显示错误值，与实际计算结果不符。

## 根因分析
- **直接原因**: 前后端计算逻辑不一致，API 返回的数据未正确映射
- **深层原因**: 
  1. 利润区间计算公式在多处重复实现
  2. 后端 StandardCost 模型计算逻辑冗余（300行→优化后）
  3. 前端直接使用未经验证的 API 响应
- **涉及文件**: 
  - `backend/controllers/costController.js`
  - `backend/controllers/standardCostController.js`
  - `backend/models/StandardCost.js`
  - `frontend/src/views/cost/CostAdd.vue`
  - `frontend/src/views/cost/StandardCost.vue`

## 触发条件 ⚠️ 关键
```yaml
patterns:
  - type: code_pattern
    regex: "profit.*margin|利润.*区间|毛利.*计算"
    description: "涉及利润计算的代码需仔细核对公式"
  - type: code_pattern
    regex: "\\*\\s*100|\\*\\s*0\\.\\d+|/\\s*100"
    description: "百分比转换操作易出错"
  - type: scenario
    description: "修改成本计算逻辑时，必须同步前后端"
  - type: keyword
    words: ["利润", "毛利", "profit", "margin", "区间", "percent"]
```

## 修复方案
1. 统一计算逻辑到后端 `costCalculator.js`
2. 前端只负责显示，不做二次计算
3. 添加调试脚本验证 API 响应

## 预防检查清单
- [ ] 利润/成本计算公式统一在后端实现
- [ ] 修改计算逻辑后必须运行验证脚本
- [ ] 前端显示值与 API 响应必须一一对应
- [ ] 单元测试覆盖边界值（0%、100%、负数）

## 相关问题
- 同类: PM-006 (工价系数重复计算)
- 模式: LOGIC - 业务计算逻辑
