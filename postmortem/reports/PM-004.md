# PM-004: 删除操作缺少引用检查

## 元信息
- **ID**: PM-004
- **修复Commit**: 750549b, 3bdf2ec
- **影响范围**: 后端包装配置、原料管理
- **根因类别**: `STATE_MGMT`

## 问题描述
删除包装配置或原料时，未检查是否被报价单引用，导致：
1. 数据完整性被破坏
2. 报价单中出现孤立引用
3. 标准成本历史记录丢失

## 根因分析
- **直接原因**: 删除接口直接执行 DELETE 无前置检查
- **深层原因**: 
  1. 未建立数据依赖关系图
  2. 缺少软删除机制
  3. 级联删除策略不明确
- **涉及文件**: 
  - `backend/controllers/process/packagingConfigController.js`
  - `backend/controllers/master/materialController.js`
  - `backend/models/QuotationItem.js`

## 触发条件 ⚠️ 关键
```yaml
patterns:
  - type: code_pattern
    regex: "\\.destroy\\(\\)|DELETE FROM(?!.*WHERE.*=.*null)"
    description: "直接删除操作未检查关联数据"
  - type: code_pattern
    regex: "async\\s+delete[^{]*\\{[^}]*destroy"
    description: "删除方法中直接调用 destroy 无引用检查"
  - type: scenario
    description: "新增删除功能时，需检查是否有外键引用该表"
  - type: keyword
    words: ["destroy", "delete", "删除", "外键", "引用", "级联"]
```

## 修复方案
1. 删除前检查引用：
```javascript
const usedInQuotations = await QuotationItem.isMaterialUsed(id);
if (usedInQuotations) {
  return res.status(400).json({ error: '该原料已被报价单使用，无法删除' });
}
```
2. 改用软删除（设置 deleted_at）
3. 级联删除相关记录

## 预防检查清单
- [ ] 所有删除接口必须先检查外键引用
- [ ] 主数据删除使用阻止模式（提示用户）
- [ ] 历史记录类数据使用软删除
- [ ] 删除操作必须在事务中执行

## 相关问题
- 模式: STATE_MGMT - 数据状态一致性
