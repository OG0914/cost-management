# PM-003: BOM数据类型转换错误

## 元信息
- **ID**: PM-003
- **修复Commit**: 332c50c
- **影响范围**: 后端 BOM 模型
- **根因类别**: `PRECISION`

## 问题描述
BOM (物料清单) 中的 `usage_amount` 和 `unit_price` 字段存储为字符串类型，导致数值计算错误。

## 根因分析
- **直接原因**: 数据库字段类型为 TEXT，Sequelize 返回字符串
- **深层原因**: 
  1. SQLite 不强制类型，允许任意类型存储
  2. 模型层缺少类型转换 getter
  3. Excel 导入时未做类型转换
- **涉及文件**: `backend/models/ModelBom.js`

## 触发条件 ⚠️ 关键
```yaml
patterns:
  - type: code_pattern
    regex: "type:\\s*DataTypes\\.TEXT.*(?:amount|price|cost|quantity)"
    description: "金额/数量字段使用 TEXT 类型存储"
  - type: code_pattern
    regex: "parseFloat|parseInt|Number\\("
    description: "频繁的运行时类型转换暗示模型层类型定义不当"
  - type: keyword
    words: ["usage_amount", "unit_price", "NaN", "类型转换", "parseFloat"]
```

## 修复方案
在模型 getter 中自动转换为数字：
```javascript
usage_amount: {
  type: DataTypes.TEXT,
  get() {
    const value = this.getDataValue('usage_amount');
    return value ? parseFloat(value) : 0;
  }
}
```

## 预防检查清单
- [ ] 所有数值字段必须在模型层定义类型转换
- [ ] 金额字段使用 DECIMAL 类型或在 getter 中转换
- [ ] 单元测试覆盖数值字段的计算场景
- [ ] Excel 导入后验证数据类型

## 相关问题
- 同类: PM-006 (工价系数重复计算)
- 模式: PRECISION - 数值精度
