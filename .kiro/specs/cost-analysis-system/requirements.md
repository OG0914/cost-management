# 成本分析管理系统 - 需求文档

## 项目简介

本系统旨在构建一个轻量级、可扩展、低维护成本的网页版成本分析管理系统，取代目前依赖 Excel 的人工审核流程。通过固定计算公式、标准化原料/工价数据、自动生成多档利润报价，显著减少审核人工作量，并统一计算逻辑。

系统将服务于六类用户角色：管理员、采购人员、生产人员、审核人员、业务员和只读账号，每个角色具有不同的权限和操作范围。

## 需求列表

### 需求 1：用户认证与权限管理

**用户故事：** 作为系统管理员，我希望能够管理不同角色的用户账号，以便控制各类人员的系统访问权限和操作范围。

#### 验收标准

1. WHEN 用户访问系统 THEN 系统 SHALL 显示登录页面要求输入用户名和密码
2. WHEN 用户输入正确的凭证 THEN 系统 SHALL 验证用户身份并根据角色跳转到对应的功能页面
3. WHEN 用户输入错误的凭证 THEN 系统 SHALL 显示错误提示并拒绝访问
4. IF 用户角色为管理员 THEN 系统 SHALL 允许访问所有功能模块（法规、型号、包材维护、用户管理）
5. IF 用户角色为采购 THEN 系统 SHALL 仅允许导入/导出原料单价
6. IF 用户角色为生产 THEN 系统 SHALL 仅允许导入/导出工价
7. IF 用户角色为审核人 THEN 系统 SHALL 允许审核、批注、导出和查看差异高亮
8. IF 用户角色为业务员 THEN 系统 SHALL 允许增查删改提交报价单
9. IF 用户角色为只读账号 THEN 系统 SHALL 仅允许查看和导出报价单
10. WHEN 管理员创建新用户 THEN 系统 SHALL 要求指定用户名、密码和角色类型

### 需求 2：法规与型号管理

**用户故事：** 作为管理员，我希望能够维护法规类别和产品型号，以便为不同的产品配置标准的原料、工价和包材数据。

#### 验收标准

1. WHEN 管理员访问法规管理页面 THEN 系统 SHALL 显示所有法规类别列表（如 NIOSH、GB、CE、ASNZS）
2. WHEN 管理员新增法规类别 THEN 系统 SHALL 要求输入法规名称和描述信息
3. WHEN 管理员编辑法规类别 THEN 系统 SHALL 允许修改法规名称和描述
4. WHEN 管理员禁用法规类别 THEN 系统 SHALL 标记该法规为不可用状态但保留历史数据
5. WHEN 管理员访问型号管理页面 THEN 系统 SHALL 显示所有型号及其绑定的法规类别
6. WHEN 管理员新增型号 THEN 系统 SHALL 要求选择法规类别并输入型号名称和备注
7. WHEN 型号创建成功 THEN 系统 SHALL 允许为该型号配置标准原料、工价和包材
8. WHEN 管理员删除型号 THEN 系统 SHALL 检查是否有关联的报价单，如有则拒绝删除

### 需求 3：原料管理

**用户故事：** 作为采购人员，我希望能够导入和管理原料价格数据，以便系统在生成报价单时使用最新的原料单价。

#### 验收标准

1. WHEN 采购人员访问原料管理页面 THEN 系统 SHALL 显示所有原料的名称、单位、单价、币别和更新时间
2. WHEN 采购人员点击导入按钮 THEN 系统 SHALL 允许上传 Excel 文件（包含列：原料名、单位、单价、币别）
3. WHEN Excel 文件上传成功 THEN 系统 SHALL 解析文件内容并验证数据格式
4. IF 原料名称已存在 THEN 系统 SHALL 更新该原料的单价和更新时间
5. IF 原料名称不存在 THEN 系统 SHALL 创建新的原料记录
6. WHEN 原料数据更新完成 THEN 系统 SHALL 显示导入成功的记录数和失败的记录数
7. WHEN 采购人员手动编辑原料 THEN 系统 SHALL 允许修改单位、单价和币别
8. WHEN 原料价格发生变化 THEN 系统 SHALL 记录历史价格以支持价格追溯
9. WHEN 采购人员导出原料数据 THEN 系统 SHALL 生成包含所有原料信息的 Excel 文件

### 需求 4：工价管理

**用户故事：** 作为生产人员，我希望能够导入和管理工序价格数据，以便系统在生成报价单时使用准确的工价信息。

#### 验收标准

1. WHEN 生产人员访问工价管理页面 THEN 系统 SHALL 显示所有工序的名称、单价、适用型号和更新时间
2. WHEN 生产人员点击导入按钮 THEN 系统 SHALL 允许上传 Excel 文件（包含列：工序名称、单价、适用型号）
3. WHEN Excel 文件上传成功 THEN 系统 SHALL 解析文件内容并验证数据格式
4. IF 工序名称和型号组合已存在 THEN 系统 SHALL 更新该工序的单价
5. IF 工序名称和型号组合不存在 THEN 系统 SHALL 创建新的工序记录
6. WHEN 工价数据更新完成 THEN 系统 SHALL 显示导入成功的记录数和失败的记录数
7. WHEN 生产人员手动编辑工价 THEN 系统 SHALL 允许修改单价和适用型号
8. WHEN 生产人员导出工价数据 THEN 系统 SHALL 生成包含所有工序信息的 Excel 文件
9. WHEN 生产人员下载导入模板 THEN 系统 SHALL 提供标准格式的 Excel 模板文件

### 需求 5：包材管理

**用户故事：** 作为管理员，我希望能够维护包材数据，以便系统在生成报价单时自动计算包材成本。

#### 验收标准

1. WHEN 管理员访问包材管理页面 THEN 系统 SHALL 显示所有包材的名称、用量、单价、币别和型号绑定
2. WHEN 管理员新增包材 THEN 系统 SHALL 要求输入包材名称、用量、单价、币别并选择绑定的型号
3. WHEN 管理员编辑包材 THEN 系统 SHALL 允许修改用量、单价和币别
4. WHEN 管理员删除包材 THEN 系统 SHALL 检查是否有关联的报价单，如有则拒绝删除
5. WHEN 包材绑定到型号 THEN 系统 SHALL 在该型号的报价单中自动包含该包材成本

### 需求 6：成本分析与报价生成（核心功能）

**用户故事：** 作为业务员，我希望能够快速生成报价单，系统自动计算成本价、管销价和利润报价，以便我能高效地为客户提供准确的报价。

#### 验收标准

1. WHEN 业务员点击新增报价单 THEN 系统 SHALL 显示报价单创建表单
2. WHEN 业务员选择法规类别 THEN 系统 SHALL 显示该法规下的所有可用型号
3. WHEN 业务员选择型号 THEN 系统 SHALL 自动加载该型号绑定的标准原料、工价和包材数据
4. WHEN 业务员选择内销或外销 THEN 系统 SHALL 根据销售类型应用不同的计算公式
5. WHEN 业务员填写客户名称、客户地区、购买数量和运费总价 THEN 系统 SHALL 实时计算运费成本（运费总价 ÷ 数量）
6. WHEN 所有必填项填写完成 THEN 系统 SHALL 自动计算成本价（原料总价 + 工价总价 + 包材总价 + 运费成本）
7. WHEN 成本价计算完成 THEN 系统 SHALL 自动计算管销价（成本价 ÷ (1 - 0.2)）
8. IF 销售类型为内销 THEN 系统 SHALL 计算内销价（管销价 × 1.13）
9. IF 销售类型为外销 THEN 系统 SHALL 计算外销价（管销价 ÷ 汇率）并计算保险价（外销价 × 1.003）
10. WHEN 基础价格计算完成 THEN 系统 SHALL 自动生成利润区间报价（基础价 × (1 + 5%)、基础价 × (1 + 10%)、基础价 × (1 + 25%)、基础价 × (1 + 50%)）
11. WHEN 业务员修改自动带出的原料、工价或包材数据 THEN 系统 SHALL 标记该项为已修改状态（蓝色高亮）
12. WHEN 业务员保存报价单 THEN 系统 SHALL 将报价单状态设置为草稿
13. WHEN 业务员提交报价单 THEN 系统 SHALL 将报价单状态更改为已提交并通知审核人
14. WHEN 报价单页面显示 THEN 系统 SHALL 使用类 Excel 表格布局，固定栏位不可编辑，变动栏位可编辑

### 需求 7：报价单审核流程

**用户故事：** 作为审核人，我希望能够查看和审核业务员提交的报价单，并能够批注或退回不符合要求的报价单，以确保报价的准确性。

#### 验收标准

1. WHEN 审核人访问审核页面 THEN 系统 SHALL 显示所有状态为已提交的报价单列表
2. WHEN 审核人点击查看报价单 THEN 系统 SHALL 显示报价单详情并高亮显示所有修改项（蓝色背景）
3. WHEN 审核人查看报价单 THEN 系统 SHALL 显示原料、工价、包材的标准配置与实际使用的对比
4. WHEN 审核人点击通过按钮 THEN 系统 SHALL 将报价单状态更改为已审核并显示绿色边框
5. WHEN 审核人点击退回按钮 THEN 系统 SHALL 要求输入退回原因
6. WHEN 审核人输入退回原因并确认 THEN 系统 SHALL 将报价单状态更改为已退回，显示红色边框和备注气泡，并通知业务员
7. WHEN 业务员收到退回通知 THEN 系统 SHALL 允许业务员修改报价单并重新提交
8. WHEN 审核人添加批注 THEN 系统 SHALL 保存批注内容并在报价单上显示批注标记

### 需求 8：报价单导出

**用户故事：** 作为审核人或业务员，我希望能够导出报价单为 Excel 或 PDF 格式，以便发送给客户或存档。

#### 验收标准

1. WHEN 用户点击导出按钮 THEN 系统 SHALL 显示导出格式选项（XLSX / PDF）
2. WHEN 用户选择 XLSX 格式 THEN 系统 SHALL 生成 Excel 文件并复刻原 Excel 样式
3. WHEN 用户选择 PDF 格式 THEN 系统 SHALL 生成 PDF 文件并保持表格格式
4. WHEN 导出文件生成 THEN 系统 SHALL 在表头包含客户信息、型号和法规类别
5. WHEN 导出文件生成 THEN 系统 SHALL 在表体分区显示原料、工价和包材明细
6. WHEN 导出文件生成 THEN 系统 SHALL 在尾部显示自动生成的利润区间报价表
7. WHEN 导出文件生成 THEN 系统 SHALL 保留格式颜色和单元格合并
8. WHEN 导出文件生成 THEN 系统 SHALL 自动写入审核人姓名和生成时间
9. WHEN 导出完成 THEN 系统 SHALL 提供文件下载链接

### 需求 9：系统配置管理

**用户故事：** 作为管理员，我希望能够配置系统的全局参数（如管销率、增值税率、汇率等），以便系统使用最新的计算参数。

#### 验收标准

1. WHEN 管理员访问系统配置页面 THEN 系统 SHALL 显示所有可配置参数（管销率、增值税率、保险率、汇率、利润区间）
2. WHEN 管理员修改管销率 THEN 系统 SHALL 验证输入值为 0 到 1 之间的小数
3. WHEN 管理员修改增值税率 THEN 系统 SHALL 验证输入值为 0 到 1 之间的小数
4. WHEN 管理员修改保险率 THEN 系统 SHALL 验证输入值为 0 到 1 之间的小数
5. WHEN 管理员修改汇率 THEN 系统 SHALL 验证输入值为正数
6. WHEN 管理员修改利润区间 THEN 系统 SHALL 允许添加、删除或修改利润百分比值
7. WHEN 管理员保存配置 THEN 系统 SHALL 更新数据库中的配置值并立即生效
8. WHEN 配置参数更新 THEN 系统 SHALL 在新的报价单中使用更新后的参数
9. WHEN 配置参数更新 THEN 系统 SHALL 保留历史报价单使用的旧参数值

### 需求 10：仪表盘与数据统计

**用户故事：** 作为管理员或审核人，我希望能够查看系统的关键指标和统计数据，以便了解系统使用情况和业务趋势。

#### 验收标准

1. WHEN 用户访问仪表盘 THEN 系统 SHALL 显示报价次数统计（按时间段）
2. WHEN 用户访问仪表盘 THEN 系统 SHALL 显示平均审核时长统计
3. WHEN 用户访问仪表盘 THEN 系统 SHALL 显示各型号的成本趋势图表
4. WHEN 用户访问仪表盘 THEN 系统 SHALL 显示待审核报价单数量
5. WHEN 用户访问仪表盘 THEN 系统 SHALL 显示已通过和已退回的报价单数量
6. WHEN 用户点击统计卡片 THEN 系统 SHALL 跳转到对应的详细页面
7. WHEN 仪表盘数据更新 THEN 系统 SHALL 实时刷新显示的统计数据

### 需求 11：数据导入错误处理

**用户故事：** 作为采购或生产人员，当我导入的 Excel 文件存在格式错误或数据问题时，我希望系统能够明确提示错误原因，以便我能够修正数据后重新导入。

#### 验收标准

1. WHEN Excel 文件格式不正确 THEN 系统 SHALL 显示错误提示"文件格式不支持，请上传 .xlsx 文件"
2. WHEN Excel 文件缺少必需列 THEN 系统 SHALL 显示错误提示并列出缺少的列名
3. WHEN Excel 文件中存在空行 THEN 系统 SHALL 跳过空行并继续处理其他数据
4. WHEN Excel 文件中存在数据类型错误 THEN 系统 SHALL 显示具体的行号和错误原因
5. WHEN Excel 文件中存在重复数据 THEN 系统 SHALL 显示警告并询问是否覆盖
6. WHEN 导入过程中发生错误 THEN 系统 SHALL 回滚所有更改并保持数据一致性
7. WHEN 导入完成 THEN 系统 SHALL 生成导入报告，包含成功数量、失败数量和错误详情

### 需求 12：历史数据查询与追溯

**用户故事：** 作为业务员或审核人，我希望能够查询历史报价单和价格变化记录，以便进行成本对比和价格追溯。

#### 验收标准

1. WHEN 用户访问成本记录页面 THEN 系统 SHALL 显示所有历史报价单列表
2. WHEN 用户使用筛选条件 THEN 系统 SHALL 支持按客户名称、型号、日期范围、状态进行筛选
3. WHEN 用户点击查看历史报价单 THEN 系统 SHALL 显示该报价单的完整详情
4. WHEN 用户查看原料价格历史 THEN 系统 SHALL 显示该原料的价格变化时间线
5. WHEN 用户查看工价历史 THEN 系统 SHALL 显示该工序的价格变化时间线
6. WHEN 用户对比两个报价单 THEN 系统 SHALL 高亮显示差异项
7. WHEN 用户导出历史数据 THEN 系统 SHALL 生成包含筛选结果的 Excel 文件
