---
name: superpowers-finishing-branch
description: 完成开发分支。实现完成、所有测试通过后使用，指导如何整合工作 - 合并、PR或清理。
---

# 完成开发分支

## 概述

通过呈现清晰选项和处理所选工作流，指导完成开发工作。

**核心原则：** 验证测试 → 呈现选项 → 执行选择 → 清理

## 流程

### 步骤1：验证测试

**呈现选项前，验证测试通过：**

```bash
# 运行项目的测试套件
npm test / cargo test / pytest / go test ./...
```

**如测试失败：**
```
测试失败（<N> 失败）。完成前必须修复：

[显示失败]

测试通过前无法进行合并/PR。
```

停止。不要进入步骤2。

**如测试通过：** 继续步骤2。

### 步骤2：确定基础分支

```bash
# 尝试常见基础分支
git merge-base HEAD main 2>/dev/null || git merge-base HEAD master 2>/dev/null
```

或询问："这个分支从main分出 - 正确吗？"

### 步骤3：呈现选项

呈现正好这4个选项：

```
实现完成。你想做什么？

1. 本地合并回 <基础分支>
2. 推送并创建Pull Request
3. 保持分支原样（我稍后处理）
4. 丢弃此工作

选择哪个？
```

**不要添加解释** - 保持选项简洁。

### 步骤4：执行选择

#### 选项1：本地合并

```bash
# 切换到基础分支
git checkout <base-branch>

# 拉取最新
git pull

# 合并功能分支
git merge <feature-branch>

# 验证合并结果的测试
<test command>

# 如测试通过
git branch -d <feature-branch>
```

然后：清理工作树（步骤5）

#### 选项2：推送并创建PR

```bash
# 推送分支
git push -u origin <feature-branch>

# 创建PR
gh pr create --title "<title>" --body "$(cat <<'EOF'
## 摘要
<2-3个变更要点>

## 测试计划
- [ ] <验证步骤>
EOF
)"
```

然后：清理工作树（步骤5）

#### 选项3：保持原样

报告："保持分支 <名称>。工作树保留在 <路径>。"

**不要清理工作树。**

#### 选项4：丢弃

**先确认：**
```
这将永久删除：
- 分支 <名称>
- 所有提交：<提交列表>
- 工作树在 <路径>

输入 'discard' 确认。
```

等待精确确认。

如确认：
```bash
git checkout <base-branch>
git branch -D <feature-branch>
```

然后：清理工作树（步骤5）

### 步骤5：清理工作树

**对于选项1、2、4：**

检查是否在工作树中：
```bash
git worktree list | grep $(git branch --show-current)
```

如是：
```bash
git worktree remove <worktree-path>
```

**对于选项3：** 保留工作树。

## 快速参考

| 选项 | 合并 | 推送 | 保留工作树 | 清理分支 |
|------|------|------|-----------|---------|
| 1. 本地合并 | ✓ | - | - | ✓ |
| 2. 创建PR | - | ✓ | ✓ | - |
| 3. 保持原样 | - | - | ✓ | - |
| 4. 丢弃 | - | - | - | ✓ (强制) |

## 常见错误

**跳过测试验证**
- **问题：** 合并损坏代码，创建失败PR
- **修复：** 提供选项前总是验证测试

**开放式问题**
- **问题：** "接下来做什么？" → 模糊
- **修复：** 呈现正好4个结构化选项

**自动清理工作树**
- **问题：** 可能需要时移除工作树（选项2、3）
- **修复：** 只对选项1和4清理

**丢弃不确认**
- **问题：** 意外删除工作
- **修复：** 要求输入 "discard" 确认

## 红旗

**绝不：**
- 测试失败时继续
- 不验证结果测试就合并
- 不确认就删除工作
- 不明确要求就强制推送

**总是：**
- 提供选项前验证测试
- 呈现正好4个选项
- 选项4需要输入确认
- 只对选项1和4清理工作树
