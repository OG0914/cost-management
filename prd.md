非常好，这将是你这套「轻量化成本分析管理系统」的正式落地方案。
下面是根据你提供的技术栈与修正版逻辑、符合**编码原则的完整PRD文档**（Product Requirements Document）。
我会在结构上对齐正式企业内部标准文档格式，同时保持可直接交给开发使用。

---

# 📘 成本分析管理系统 PRD（修正版）

## 1️⃣ 项目概述

### 🎯 项目目标

构建一个**轻量级、可扩展、低维护成本**的网页版成本分析管理系统，取代目前依赖Excel的人工审核流程。
通过固定计算公式、标准化原料/工价数据、自动生成多档利润报价，显著减少审核人工作量，并统一计算逻辑。

---

## 2️⃣ 技术栈与开发框架

| 层级   | 技术栈                                          | 用途                            |
| ---- | -------------------------------------------- | ----------------------------- |
| 前端   | **Vue3 + Element Plus + Tailwind + 原生HTML5** | 表单输入、数据绑定、表格展示与交互（仿Excel表格结构） |
| 后端   | **Node.js + Express**                        | API服务、计算逻辑、用户与权限控制、文件导出       |
| 数据库  | **better-sqlite3**                           | 轻量本地数据库，适合内网环境                |
| 报表导出 | **ExcelJS / XLSX**                           | 报价单导出（复刻原Excel表样式）            |

---

## 3️⃣ 系统核心逻辑（修正版）

### 3.1 成本计算公式

| 项目      | 计算公式                      | 说明                    |
| ------- | ------------------------- | --------------------- |
| 成本价     | 原料总价 + 工价总价 + 包材总价 + 运费成本 | 自动汇总                  |
| 管销价     | 成本价 ÷ (1 - 管销率)           | 默认管销率 20%（即 ÷0.8）     |
| 内销价（含税） | 管销价 × (1 + 13%)           | 增值税率固定13%             |
| 外销价（未税） | 管销价 ÷ 汇率                  | 汇率系统配置，默认人民币兑美元       |
| 外销保险价   | 外销价 × (1 + 0.003)         | 保险率0.3%               |
| 利润区间报价  | 基础价 × (1 + 利润%)           | 自动生成多档：5%、10%、25%、50% |

---

## 4️⃣ 系统模块设计

### 4.1 法规与型号模块

* **法规类别维护**

  * 示例：口罩（NIOSH、GB、CE、ASNZS）、半面罩（NIOSH、GB、CE）
  * 管理员可新增、禁用、编辑法规类别。

* **型号维护**

  * 型号绑定法规类别；
  * 每个型号对应标准原料配置、工价、包材；
  * 由管理员导入或新增。

---

### 4.2 原物料模块

* **数据来源**：采购人员导入Excel。
* **内容字段**：`原料名称 | 单位 | 单价 | 币别 | 更新时间`
* **用途**：

  * 新增报价单时，系统自动匹配对应原料单价；
  * 支持价格追溯（记录历史价格变化）。

---

### 4.3 工价模块

* **数据来源**：生产人员导入。
* **字段**：`工序名称 | 单价 | 适用型号 | 更新时间`
* **特点**：

  * 每个型号的工序可不同；
  * 支持导入和模板导出。

---

### 4.4 包材模块

* **数据来源**：管理员维护；
* **字段**：`包材名称 | 用量 | 单价 | 币别 | 型号绑定`

---

### 4.5 成本分析与报价模块（核心）

#### 🧾 流程：

1. 业务点击「新增报价单」
2. 选择法规类别 → 型号 → 内/外销
3. 系统自动带出对应原料、工价、包材、用量与价格
4. 业务仅需填写：

   * 客户名称
   * 购买数量（如不确定则按MOQ）
   * 客户地区
   * 运费总价（系统计算每片运费成本 = 运费总价 ÷ 数量）

#### 🧮 系统自动计算：

```
成本价 = 原料 + 工价 + 包材 + 运费
管销价 = 成本价 ÷ (1 - 管销率)
内销价 = 管销价 × 1.13
外销价 = 管销价 ÷ 汇率
保险价 = 外销价 × 1.003
利润区间报价 = 基础价 × (1 + 利润%)
```

#### 💡 前端表现：

* 表格布局与Excel一致；
* 固定栏位不可编辑；
* 变动栏位变色（蓝色高亮）；
* 实时计算显示；
* 审核人可一键查看差异项。

---

### 4.6 报价单导出模块

* 报价单导出支持 **XLSX / PDF**
* 模板复刻Excel格式：

  * 表头含客户信息、型号、法规类别；
  * 表体分区：原料 / 工价 / 包材；
  * 尾部为自动生成的利润区间报价表；
* 导出保留格式颜色与单元格合并；
* 审核人、生成时间自动写入。

---

## 5️⃣ 用户与权限设计

| 角色         | 权限说明                 |
| ---------- | -------------------- |
| **管理员**    | 全权限（法规、型号、包材维护、用户管理） |
| **采购**     | 导入/导出原料单价            |
| **生产**     | 导入/导出工价              |
| **审核人（K）** | 审核、批注、导出、查看差异高亮      |
| **业务员**    | 增查删改提交报价单            |
| **只读账号**   | 仅查看与导出               |

---

## 6️⃣ 界面设计要点

| 页面    | 关键功能                | 元素                        |
| ----- | ------------------- | ------------------------- |
| 登录页   | 用户认证、角色识别           | Element Plus 表单组件         |
| 仪表盘   | 导航至报价管理、法规类别、原物料管理等 | 卡片式导航（Tailwind Grid布局）    |
| 报价管理页 | 类Excel表格、实时计算       | Vue3 双向绑定 + Tailwind 表格样式 |
| 审核页   | 差异比对、高亮显示           | 蓝色背景 + 备注区域               |
| 导出页   | 报价单预览、XLSX/PDF导出    | ExcelJS / jsPDF           |

---

## 7️⃣ 数据表设计（简版）

### 表1：`regulation`

| 字段          | 类型      | 描述   |
| ----------- | ------- | ---- |
| id          | INTEGER | 主键   |
| name        | TEXT    | 法规类别 |
| description | TEXT    | 说明   |

### 表2：`model`

| 字段            | 类型      | 描述 |
| ------------- | ------- | -- |
| id            | INTEGER | 主键 |
| regulation_id | INTEGER | 外键 |
| model_name    | TEXT    | 型号 |
| remark        | TEXT    | 备注 |

### 表3：`material`

| 字段         | 类型      | 描述   |
| ---------- | ------- | ---- |
| id         | INTEGER | 主键   |
| name       | TEXT    | 原料名  |
| unit       | TEXT    | 单位   |
| price      | REAL    | 单价   |
| currency   | TEXT    | 币别   |
| updated_at | TEXT    | 更新时间 |

### 表4：`quotation`

| 字段             | 类型      | 描述             |
| -------------- | ------- | -------------- |
| id             | INTEGER | 主键             |
| customer_name  | TEXT    | 客户名称           |
| region         | TEXT    | 客户地区           |
| model_id       | INTEGER | 型号外键           |
| regulation_id  | INTEGER | 法规类别           |
| quantity       | INTEGER | 购买数量           |
| freight_total  | REAL    | 运费总价           |
| sales_type     | TEXT    | 内销/外销          |
| base_cost      | REAL    | 成本价            |
| overhead_price | REAL    | 管销价            |
| currency       | TEXT    | 币别             |
| created_by     | TEXT    | 创建者            |
| status         | TEXT    | 状态（草稿、已提交、已审核） |

### 表5：`quotation_item`

| 字段           | 类型      | 描述         |
| ------------ | ------- | ---------- |
| id           | INTEGER | 主键         |
| quotation_id | INTEGER | 外键         |
| category     | TEXT    | 原料/工价/包材   |
| name         | TEXT    | 名称         |
| usage        | REAL    | 用量         |
| price        | REAL    | 单价         |
| subtotal     | REAL    | 小计         |
| is_changed   | BOOLEAN | 是否修改（变色提示） |

---

## 8️⃣ 审核机制与颜色规则

| 状态   | 表示          | 说明       |
| ---- | ----------- | -------- |
| 默认   | 白色          | 标准配置项    |
| 修改后  | 浅蓝          | 业务员修改的栏位 |
| 审核通过 | 绿色边框        | 审核人确认通过  |
| 审核退回 | 红色边框 + 备注气泡 | 审核驳回原因   |

---

## 9️⃣ 导入导出标准

| 模块   | 导入格式                      | 说明                |
| ---- | ------------------------- | ----------------- |
| 原料导入 | `.xlsx` 文件，列：原料名、单位、单价、币别 | 自动更新旧记录           |
| 工价导入 | `.xlsx` 文件，列：工序、单价、型号     |                   |
| 报价导出 | `.xlsx` / `.pdf`          | 保留Excel格式、颜色、公式结果 |

---

## 🔧 10️⃣ 系统配置项（Config表）

| 配置项  | 默认值                      | 说明      |
| ---- | ------------------------ | ------- |
| 管销率  | 0.2                      | 可调整     |
| 增值税率 | 0.13                     | 内销      |
| 保险率  | 0.003                    | 外销      |
| 汇率   | 7.2                      | RMB→USD |
| 利润区间 | [0.05, 0.10, 0.25, 0.50] | 自动生成    |

---

## 11️⃣ 开发原则与架构

### ✅ 编码原则

1. **模块化结构**：前后端代码分离，前端 Vue 组件粒度控制在单页功能级；
2. **数据驱动**：所有价格、汇率、公式参数均来源数据库；
3. **轻量无依赖**：仅使用必要依赖，适配内网部署；
4. **可维护性优先**：注释清晰、结构统一；
5. **防呆逻辑**：前端锁定公式栏，防止误操作；
6. **一致性设计**：所有数值计算在后端完成。

---

## 12️⃣ 部署方式

* **运行环境**：Windows Server / Node.js v22+
* **数据库文件**：`/data/cost_analysis.db`
* **启动命令**：

  ```bash
  npm install
  npm run start
  ```
* **访问路径**：
  内网服务器IP: `http://192.168.x.x:3000`

---

