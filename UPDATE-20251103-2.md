# 报价单系统更新 - 2025年11月3日（第二次）

## 更新内容

### 1. 区分内销和外销的最终价格标签 ✅

**需求描述：**
- 内销：显示"最终成本价（含13%增值税）"
- 外销：显示"最终成本价（不含增值税）"

**实施方案：**
- 在新增报价单页面（CostAdd.vue）中，使用条件判断根据销售类型显示不同的标签
- 在报价单详情页面（CostDetail.vue）中，同样使用条件判断
- 内销显示含税价格（CNY），外销显示不含税价格（USD）

**修改文件：**
- `frontend/src/views/cost/CostAdd.vue`
- `frontend/src/views/cost/CostDetail.vue`

### 2. 外销时显示汇率 ✅

**需求描述：**
在新增报价单页面，当选择外销时，在成本计算卡片中显示当前使用的汇率。

**实施方案：**
- 在成本计算的 `el-descriptions` 中添加"汇率（CNY/USD）"显示项
- 仅在外销时显示（使用 `v-if="form.sales_type === 'export'"`）
- 从 `calculation.exchangeRate` 获取汇率值
- 后端在外销计算结果中返回 `exchangeRate` 字段
- 详情页面也同样显示汇率

**修改文件：**
- `backend/utils/costCalculator.js`
- `frontend/src/views/cost/CostAdd.vue`
- `frontend/src/views/cost/CostDetail.vue`

## 技术细节

### 前端标签条件渲染

**新增报价单页面（CostAdd.vue）：**
```vue
<el-descriptions-item 
  :label="form.sales_type === 'domestic' ? '最终成本价（含13%增值税）' : '最终成本价（不含增值税）'"
>
  <span v-if="form.sales_type === 'domestic'">
    {{ calculation.domesticPrice?.toFixed(4) || '0.0000' }} CNY
  </span>
  <span v-else>
    {{ calculation.exportPrice?.toFixed(4) || '0.0000' }} USD
  </span>
</el-descriptions-item>

<!-- 外销时显示汇率 -->
<el-descriptions-item label="汇率（CNY/USD）" v-if="form.sales_type === 'export'">
  {{ calculation.exchangeRate || '7.2000' }}
</el-descriptions-item>
```

**报价单详情页面（CostDetail.vue）：**
```vue
<el-descriptions-item 
  :label="quotation.sales_type === 'domestic' ? '最终成本价（含13%增值税）' : '最终成本价（不含增值税）'"
>
  {{ quotation.final_price?.toFixed(4) }} {{ quotation.currency }}
</el-descriptions-item>

<!-- 外销时显示汇率 -->
<el-descriptions-item 
  label="汇率（CNY/USD）" 
  v-if="quotation.sales_type === 'export' && calculation"
>
  {{ calculation.exchangeRate || '7.2000' }}
</el-descriptions-item>
```

### 后端返回汇率

**costCalculator.js 修改：**
```javascript
// 外销计算结果中添加汇率
result = {
  ...result,
  exportPrice,
  insurancePrice,
  profitTiers,
  currency: 'USD',
  exchangeRate: this.exchangeRate  // 新增：返回汇率
};
```

## 用户界面变化

### 新增报价单页面

**内销时：**
- 成本计算卡片显示：
  - 运费成本（每片）
  - 基础成本价
  - 管销价
  - **最终成本价（含13%增值税）** - CNY

**外销时：**
- 成本计算卡片显示：
  - 运费成本（每片）
  - 基础成本价
  - 管销价
  - **最终成本价（不含增值税）** - USD
  - **汇率（CNY/USD）** - 例如：7.2000
  - 保险价 - USD

### 报价单详情页面

**内销时：**
- 成本计算卡片显示：
  - 运费成本（每片）
  - 基础成本价
  - 管销价
  - 运费计入成本
  - **最终成本价（含13%增值税）** - CNY

**外销时：**
- 成本计算卡片显示：
  - 运费成本（每片）
  - 基础成本价
  - 管销价
  - 运费计入成本
  - **最终成本价（不含增值税）** - USD
  - **汇率（CNY/USD）** - 例如：7.2000

## 价格说明

### 内销价格计算

**含13%增值税的最终成本价：**

1. **运费计入基础成本价（是）：**
   ```
   基础成本价 = 原料 + 工序 + 包材 + 运费
   管销价 = 基础成本价 ÷ (1 - 管销率)
   最终成本价 = 管销价 × (1 + 13%)
   ```

2. **运费不计入基础成本价（否）：**
   ```
   基础成本价 = 原料 + 工序 + 包材
   管销价 = 基础成本价 ÷ (1 - 管销率)
   最终成本价 = (管销价 + 运费) × (1 + 13%)
   ```

### 外销价格计算

**不含增值税的最终成本价（美元）：**

1. **运费计入基础成本价（是）：**
   ```
   基础成本价 = 原料 + 工序 + 包材 + 运费
   管销价 = 基础成本价 ÷ (1 - 管销率)
   最终成本价 = 管销价 ÷ 汇率
   ```

2. **运费不计入基础成本价（否）：**
   ```
   基础成本价 = 原料 + 工序 + 包材
   管销价 = 基础成本价 ÷ (1 - 管销率)
   最终成本价 = (管销价 + 运费) ÷ 汇率
   ```

**说明：**
- 外销价格不含增值税，因为出口产品通常享受退税政策
- 汇率从系统配置中获取（默认7.2）
- 外销价格以美元（USD）计价

## 测试建议

### 1. 内销标签测试

**测试步骤：**
1. 创建新报价单
2. 选择"销售类型：内销"
3. 填写必要信息并计算
4. 验证成本计算卡片显示"最终成本价（含13%增值税）"
5. 验证价格单位为 CNY
6. 验证不显示汇率项

### 2. 外销标签和汇率测试

**测试步骤：**
1. 创建新报价单
2. 选择"销售类型：外销"
3. 填写必要信息并计算
4. 验证成本计算卡片显示"最终成本价（不含增值税）"
5. 验证价格单位为 USD
6. 验证显示"汇率（CNY/USD）"项
7. 验证汇率值正确（例如：7.2000）
8. 验证显示"保险价"项

### 3. 详情页面测试

**内销报价单：**
1. 打开内销报价单详情
2. 验证显示"最终成本价（含13%增值税）"
3. 验证不显示汇率

**外销报价单：**
1. 打开外销报价单详情
2. 验证显示"最终成本价（不含增值税）"
3. 验证显示汇率

### 4. 切换销售类型测试

**测试步骤：**
1. 创建新报价单，选择内销
2. 填写数据并计算
3. 验证显示"含13%增值税"，不显示汇率
4. 切换为外销
5. 重新计算
6. 验证显示"不含增值税"，显示汇率
7. 再切换回内销
8. 验证标签和显示项正确切换

## 示例截图说明

### 内销成本计算显示

```
成本计算
┌─────────────────────────────────────────────┐
│ 运费成本（每片）    0.0100                    │
│ 基础成本价          1.2345                    │
│ 管销价              1.5431                    │
│ 最终成本价（含13%增值税）  1.7437 CNY        │
└─────────────────────────────────────────────┘
```

### 外销成本计算显示

```
成本计算
┌─────────────────────────────────────────────┐
│ 运费成本（每片）    0.0100                    │
│ 基础成本价          1.2345                    │
│ 管销价              1.5431                    │
│ 最终成本价（不含增值税）  0.2143 USD         │
│ 汇率（CNY/USD）     7.2000                    │
│ 保险价              0.2149 USD                │
└─────────────────────────────────────────────┘
```

## 相关文件清单

### 修改文件
- `backend/utils/costCalculator.js`
- `frontend/src/views/cost/CostAdd.vue`
- `frontend/src/views/cost/CostDetail.vue`

### 新建文件
- `UPDATE-20251103-2.md`

## 完成状态

- ✅ 区分内销和外销的最终价格标签
- ✅ 外销时显示汇率
- ✅ 代码诊断通过
- ✅ 前后端联调完成

所有功能已实现完成！
