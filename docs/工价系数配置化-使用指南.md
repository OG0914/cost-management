# 工价系数配置化 - 使用指南

## 概述
工价系数已从硬编码改为可配置，管理员可以通过系统配置页面或API动态调整工价系数，无需修改代码。

## 快速开始

### 1. 查看当前配置

#### 方法一：通过数据库
```sql
SELECT * FROM system_config WHERE config_key = 'process_coefficient';
```

#### 方法二：通过API
```bash
GET /api/config/process_coefficient
```

响应示例：
```json
{
  "success": true,
  "data": {
    "key": "process_coefficient",
    "value": 1.56,
    "description": "工价系数",
    "updated_at": "2024-01-01 00:00:00"
  }
}
```

#### 方法三：通过验证脚本
```bash
node backend/scripts/checkConfig.js
```

### 2. 修改配置

#### 方法一：通过系统配置页面（推荐）
1. 登录系统（需要管理员权限）
2. 进入"系统配置管理"页面
3. 找到"工价系数"配置项
4. 修改数值（例如：从 1.56 改为 1.60）
5. 点击"保存配置"按钮

#### 方法二：通过API
```bash
PUT /api/config/process_coefficient
Content-Type: application/json
Authorization: Bearer <admin_token>

{
  "value": 1.60
}
```

#### 方法三：通过数据库（不推荐）
```sql
UPDATE system_config 
SET config_value = '1.60', updated_at = CURRENT_TIMESTAMP 
WHERE config_key = 'process_coefficient';
```

### 3. 验证修改

运行测试脚本验证配置是否正确：
```bash
node backend/test-process-coefficient.js
```

## 配置说明

### 配置项详情
- **配置键**：`process_coefficient`
- **数据类型**：数字（Number）
- **默认值**：1.56
- **验证规则**：必须是正数（> 0）
- **建议范围**：1.0 - 3.0
- **权限要求**：仅管理员可修改

### 配置影响范围
修改工价系数会影响以下功能：
1. **工序管理页面**：工序总价显示
2. **报价单新增页面**：工序总计计算
3. **报价单详情页面**：工序总计显示
4. **成本计算**：基础成本价计算

### 注意事项
⚠️ **重要**：修改配置只影响新创建的报价单，不会自动更新历史报价单。

## 使用场景

### 场景1：调整工价系数
当公司的工价成本发生变化时，管理员可以调整工价系数：

**通过系统配置页面：**
1. 进入"系统配置管理"
2. 将"工价系数"从 1.56 修改为 1.65
3. 点击"保存配置"

**或通过API：**
```bash
PUT /api/config/process_coefficient
{
  "value": 1.65
}
```

### 场景2：临时测试不同系数
在测试环境中，可以临时修改系数进行测试：

```bash
# 测试系数 1.8
PUT /api/config/process_coefficient
{
  "value": 1.8
}

# 创建测试报价单...

# 恢复原始系数
PUT /api/config/process_coefficient
{
  "value": 1.56
}
```

### 场景3：批量更新配置
如果需要同时更新多个配置：

```bash
POST /api/config/batch
{
  "configs": {
    "process_coefficient": 1.60,
    "overhead_rate": 0.22,
    "exchange_rate": 7.3
  }
}
```

## 前端集成

### 在Vue组件中使用

```vue
<script setup>
import { useConfigStore } from '@/store/config'

const configStore = useConfigStore()

// 在组件挂载时加载配置
onMounted(async () => {
  await configStore.loadConfig()
})

// 获取工价系数
const coefficient = computed(() => {
  return configStore.getProcessCoefficient()
})

// 计算工序总价
const processTotal = computed(() => {
  const sum = processes.value.reduce((total, p) => total + p.price, 0)
  return sum * coefficient.value
})
</script>

<template>
  <div>
    <p>工序总价（含系数{{ coefficient }}）: {{ processTotal }}</p>
  </div>
</template>
```

## 后端集成

### 在控制器中使用

```javascript
const SystemConfig = require('../models/SystemConfig');

// 获取工价系数
const processCoefficient = parseFloat(SystemConfig.getValue('process_coefficient')) || 1.56;

// 计算工序总价
const processSum = processes.reduce((sum, p) => sum + p.unit_price, 0);
const processTotalPrice = processSum * processCoefficient;
```

### 在计算器中使用

```javascript
const SystemConfig = require('../models/SystemConfig');
const CostCalculator = require('../utils/costCalculator');

// 获取计算器配置（包含工价系数）
const calculatorConfig = SystemConfig.getCalculatorConfig();

// 创建计算器实例
const calculator = new CostCalculator(calculatorConfig);

// 计算成本（会自动使用配置的工价系数）
const result = calculator.calculateQuotation({
  materialTotal: 100,
  processTotal: 50,  // 原始工序总价
  packagingTotal: 30,
  freightTotal: 20,
  quantity: 1000,
  salesType: 'domestic'
});
```

## 故障排查

### 问题1：配置不存在
**症状**：API返回 404 或配置值为 null

**解决方案**：
```bash
# 运行迁移脚本添加配置
node backend/scripts/add-process-coefficient.js
```

### 问题2：配置修改不生效
**症状**：修改配置后，前端显示的还是旧值

**解决方案**：
1. 刷新页面（前端会重新加载配置）
2. 检查浏览器缓存
3. 确认后端配置已更新：
```bash
node backend/scripts/checkConfig.js
```

### 问题3：计算结果不正确
**症状**：工序总价计算结果与预期不符

**解决方案**：
```bash
# 运行测试脚本验证
node backend/test-process-coefficient.js
```

### 问题4：权限不足
**症状**：修改配置时返回 403 Forbidden

**解决方案**：
- 确认使用管理员账号登录
- 检查 JWT token 是否有效
- 确认用户角色为 'admin'

## 最佳实践

1. **修改前备份**：修改配置前，先记录当前值
2. **小步调整**：建议每次调整幅度不超过 0.1
3. **测试验证**：修改后创建测试报价单验证计算结果
4. **记录变更**：在系统日志中记录配置变更原因和时间
5. **通知相关人员**：配置变更后通知相关业务人员

## 扩展功能（未来）

### 按型号配置
如果需要不同型号使用不同的工价系数：

```sql
-- 在 models 表中添加字段
ALTER TABLE models ADD COLUMN process_coefficient REAL;

-- 设置特定型号的系数
UPDATE models SET process_coefficient = 1.8 WHERE model_name = 'ABC-001';
```

### 按客户配置
如果需要不同客户使用不同的工价系数：

```sql
-- 在 customers 表中添加字段
ALTER TABLE customers ADD COLUMN process_coefficient REAL;

-- 设置特定客户的系数
UPDATE customers SET process_coefficient = 1.7 WHERE customer_name = '客户A';
```

### 配置优先级
```
客户配置 > 型号配置 > 系统默认配置
```

## 相关文档

- [问题2修正-工价系数配置化.md](./问题2修正-工价系数配置化.md) - 详细修改说明
- [问题2修正-总结.md](./问题2修正-总结.md) - 修改总结
- [系统配置说明.md](./系统配置说明.md) - 系统配置文档

## 技术支持

如有问题，请联系技术支持或查看相关文档。
