# 自定义利润档位功能说明

## 功能概述

在报价单管理系统中新增了自定义利润档位功能，允许用户在新增或编辑报价单时，除了系统预设的利润区间外，还可以添加自定义的利润百分比档位。

## 功能特点

### 1. 新增/编辑报价单页面

- **添加档位按钮**：在利润区间报价表的标题旁新增"添加档位"按钮
- **自定义输入**：点击后在表格中新增一行，可以输入自定义的利润率（如：0.35 表示 35%）
- **实时计算**：输入利润率后，系统会自动计算对应的报价金额
- **自动排序**：所有利润档位（系统预设+自定义）会按照百分比大小自动排序显示
- **删除功能**：自定义档位可以随时删除，系统预设档位不可删除
- **数据保存**：自定义档位会随报价单一起保存到数据库

### 2. 报价单详情页面

- **完整展示**：显示所有利润档位，包括系统预设和用户自定义的档位
- **区分标识**：自定义档位会有特殊标识（橙色文字"自定义利润档位"）
- **按序排列**：所有档位按利润率从低到高排序

### 3. 报价单对比页面

- **对比展示**：在型号对比模式下，每个报价单都会展示其完整的利润区间
- **包含自定义**：对比时会显示该报价单保存的所有自定义利润档位
- **视觉区分**：自定义档位使用橙色背景高亮显示，便于识别

## 技术实现

### 前端实现

1. **CostAdd.vue（新增/编辑页面）**
   - 新增 `customProfitTiers` 响应式数组存储自定义档位
   - 新增 `allProfitTiers` 计算属性合并系统档位和自定义档位并排序
   - 新增 `addCustomProfitTier()` 方法添加自定义档位
   - 新增 `updateCustomTierPrice()` 方法实时计算自定义档位价格
   - 新增 `removeCustomProfitTier()` 方法删除自定义档位
   - 保存时将自定义档位数据发送到后端

2. **CostDetail.vue（详情页面）**
   - 加载报价单时解析 `custom_profit_tiers` JSON 数据
   - 使用 `allProfitTiers` 计算属性合并并排序显示

3. **CostCompare.vue（对比页面）**
   - 新增 `getAllProfitTiers()` 方法获取每个报价单的完整利润档位
   - 在对比概览中展示所有档位
   - 使用 CSS 类 `custom-tier` 高亮显示自定义档位

### 后端实现

1. **数据库迁移**
   - 在 `quotations` 表中新增 `custom_profit_tiers` 字段（TEXT类型）
   - 用于存储 JSON 格式的自定义利润档位数组

2. **Quotation 模型**
   - 在 `create()` 方法中支持 `custom_profit_tiers` 字段
   - 在 `update()` 方法中支持更新 `custom_profit_tiers` 字段

3. **costController 控制器**
   - 在创建和更新报价单时，接收并保存 `custom_profit_tiers` 数据
   - 将数组转换为 JSON 字符串存储到数据库

## 数据格式

自定义利润档位在数据库中以 JSON 格式存储：

```json
[
  {
    "profitRate": 0.35,
    "profitPercentage": "35%",
    "price": 1234.56
  },
  {
    "profitRate": 0.75,
    "profitPercentage": "75%",
    "price": 2345.67
  }
]
```

## 使用说明

### 添加自定义利润档位

1. 在新增或编辑报价单页面，填写完基本信息和明细后
2. 滚动到"成本计算"部分的"利润区间报价"表格
3. 点击表格右上角的"添加档位"按钮
4. 在新增的行中输入利润率（如：0.35 表示 35%）
5. 系统会自动计算并显示对应的报价金额
6. 可以继续添加多个自定义档位
7. 点击"保存草稿"或"提交审核"保存数据

### 删除自定义利润档位

1. 在利润区间报价表格中找到要删除的自定义档位
2. 点击该行右侧的"删除"按钮
3. 该档位会立即从列表中移除

### 查看自定义利润档位

1. 在报价单详情页面，所有利润档位会按百分比排序显示
2. 自定义档位会标注"自定义利润档位"字样
3. 在对比页面，自定义档位会以橙色背景高亮显示

## 注意事项

1. 利润率范围：0-10（即 0%-1000%）
2. 自定义档位会与系统预设档位合并显示，并按百分比排序
3. 系统预设档位由管理员在"参数配置管理"中设置，不可在报价单中删除
4. 自定义档位仅对当前报价单有效，不会影响其他报价单
5. 复制报价单时，自定义利润档位也会一起复制

## 权限说明

- 所有用户都可以在自己创建的报价单中添加自定义利润档位
- 管理员可以在任何报价单中添加或修改自定义利润档位
- 系统预设的利润档位只能由管理员在"参数配置管理"中修改
