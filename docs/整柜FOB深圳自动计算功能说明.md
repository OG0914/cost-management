# 整柜FOB深圳自动计算功能说明

## 功能概述

当选择**整柜（FCL）+ FOB深圳**时，系统会自动计算最优装柜数量和运费。

## 自动计算逻辑

### 1. 数量自动计算

**计算公式：**
```
可装箱数 = 950 ÷ 单箱材积（向上取整）
建议数量 = 可装箱数 × 每箱只数
```

**示例1：**
- 包装：1pc/bag, 10bags/box, 12boxes/carton
- 每箱只数：120pcs
- 单箱材积：1.5立方英尺

**计算过程：**
```
可装箱数 = 950 ÷ 1.5 = 633.33 → 634箱（向上取整）
建议数量 = 634 × 120 = 76,080pcs
```

**示例2：**
- 单箱材积：2.3立方英尺
- 每箱只数：120pcs

**计算过程：**
```
可装箱数 = 950 ÷ 2.3 = 413.04 → 414箱（向上取整）
建议数量 = 414 × 120 = 49,680pcs
```

### 2. 运费固定

- 运费（美金）：$840
- 运费汇率：7.1（可在系统配置中修改）
- 运费总计：¥5964（根据运费汇率计算）

## 使用步骤

1. 选择法规类别和型号配置（必须包含外箱材积数据）
2. 选择"外销" → "整柜" → "FOB深圳"
3. 系统自动计算并填充数量
4. 数量字段变为只读（灰色）
5. 显示详细的计算明细

## 运费计算明细显示

系统会显示以下信息：

| 项目 | 说明 |
|------|------|
| 单箱材积 | 从包装配置中获取（立方英尺） |
| 可装箱数 | 950 ÷ 单箱材积（向下取整） |
| 每箱只数 | pc_per_bag × bags_per_box × boxes_per_carton |
| 建议数量 | 可装箱数 × 每箱只数（绿色高亮显示） |
| 运费（美金） | $840 |
| 运费汇率 | 7.1（可在系统配置中修改） |
| 运费总计 | ¥5964（根据运费汇率计算） |

## 包材明细新增外箱材积列

包材明细表格新增"外箱材积"列，显示每个包材的外箱材积信息。

**显示规则：**
- 有外箱材积：显示数值 + "立方英尺"
- 无外箱材积：显示"-"

## 注意事项

### 1. 必要条件

- 必须选择包含外箱材积数据的包装配置
- 外箱材积必须大于0
- 每箱只数必须大于0

### 2. 数量字段

- 整柜FOB深圳时，数量字段自动填充且只读
- 切换到其他货运方式或港口时，数量字段恢复可编辑

### 3. 计算说明

- 950是标准整柜容积（立方英尺）
- 可装箱数向上取整，与CBM计算规则一致
- 建议数量是最优装柜数量

## 界面示例

### 整柜FOB深圳运费计算明细

```
┌─────────────────────────────────────────────────┐
│ FOB深圳运费计算明细（整柜）                    │
├─────────────────────────────────────────────────┤
│ 单箱材积（立方英尺）：1.5                      │
│ 可装箱数：633箱 (950 ÷ 1.5)                   │
│ 每箱只数：120pcs                               │
│ 建议数量：75,960pcs (633 × 120)               │
│ 运费（美金）：$840                             │
│ 运费汇率（USD/CNY）：7.1                       │
│ 运费总计（人民币）：¥5964 ($840 × 7.1)        │
└─────────────────────────────────────────────────┘
```

### 包材明细表格

| 序号 | 包材名称 | 用量 | 单价 | 外箱材积 | 小计 | 操作 |
|------|---------|------|------|---------|------|------|
| 1 | 外箱 | 1 | ¥5.00 | 1.5 立方英尺 | ¥5.00 | 删除 |
| 2 | 内袋 | 10 | ¥0.50 | - | ¥5.00 | 删除 |

## 常见问题

### Q1：为什么数量字段是灰色的？

A：选择整柜FOB深圳时，数量由系统自动计算，无需手动输入。

### Q2：如何修改数量？

A：整柜FOB深圳的数量是根据最优装柜计算的，不建议修改。如需自定义数量，请选择"其他港口"。

### Q3：为什么我的包装配置没有自动计算数量？

A：请检查包装配置中是否包含外箱材积数据。如果没有，请联系管理员添加。

### Q4：950这个数字是什么？

A：950立方英尺是标准20尺整柜的可用容积。

### Q5：为什么是向上取整？

A：向上取整与CBM计算规则保持一致，符合行业惯例。例如4.1也要按5计算。

## 技术说明

### 计算触发时机

1. 选择包装配置后
2. 切换到整柜+FOB深圳时
3. 货运方式或港口类型变化时

### 数据来源

- **单箱材积**：从 `packaging_materials` 表的 `carton_volume` 字段获取
- **每箱只数**：从 `packaging_configs` 表计算（pc_per_bag × bags_per_box × boxes_per_carton）

### 前端实现

```javascript
// 整柜自动计算数量
if (shippingInfo.cartonVolume > 0 && shippingInfo.pcsPerCarton > 0) {
  const maxCartons = Math.ceil(950 / shippingInfo.cartonVolume) // 向上取整
  const suggestedQuantity = maxCartons * shippingInfo.pcsPerCarton
  form.quantity = suggestedQuantity
}
```

## 更新日志

- **2025-11-09**：新增整柜FOB深圳自动计算数量功能
- **2025-11-09**：包材明细新增外箱材积列
