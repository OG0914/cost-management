# 问题2修正：工价系数配置化

## 问题描述
工价系数 1.56 在代码中硬编码，应该将此类核心业务参数统一放在后端的 SystemConfig，前端通过 API 获取配置。

## 修正方案

### 1. 数据库层面
在 `system_config` 表中新增配置项：
- `process_coefficient`: 工价系数，默认值 1.56

执行脚本：`backend/scripts/add-process-coefficient.js`

### 2. 后端代码修改

#### 2.1 CostCalculator (backend/utils/costCalculator.js)
- 在构造函数中添加 `processCoefficient` 参数
- 修改 `calculateBaseCost` 方法，使用 `this.processCoefficient` 替代硬编码的 1.56

#### 2.2 SystemConfig (backend/models/SystemConfig.js)
- 在 `getCalculatorConfig` 方法中添加 `processCoefficient` 配置项
- 从数据库读取 `process_coefficient` 配置值

#### 2.3 ConfigController (backend/controllers/configController.js)
- 在 `validateConfigValue` 函数中添加 `process_coefficient` 的验证逻辑
- 在核心配置保护列表中添加 `process_coefficient`

#### 2.4 ProcessController (backend/controllers/processController.js)
- 在 `getAllPackagingConfigs` 和 `getPackagingConfigsByModel` 方法中
- 从 SystemConfig 获取工价系数，替代硬编码的 1.56

#### 2.5 CostController (backend/controllers/costController.js)
- 在报价单详情接口中，使用配置的工价系数计算显示总价

### 3. 前端代码修改

#### 3.1 创建配置 Store (frontend/src/store/config.js)
- 创建 Pinia store 管理系统配置
- 提供 `loadConfig` 方法从后端加载配置
- 提供 `getProcessCoefficient` 方法获取工价系数

#### 3.2 ProcessManagement.vue
- 导入并使用 `useConfigStore`
- 在 `totalProcessPrice` 计算属性中使用配置的系数
- 在页面显示中动态显示系数值

#### 3.3 CostDetail.vue
- 导入并使用 `useConfigStore`
- 在工序总计显示中使用配置的系数
- 在 `onMounted` 中加载配置

#### 3.4 CostAdd.vue
- 导入并使用 `useConfigStore`
- 在 `processTotal` 计算属性中使用配置的系数
- 在 `onMounted` 中加载配置

## 修改文件清单

### 后端文件
1. `backend/utils/costCalculator.js` - 添加 processCoefficient 参数
2. `backend/models/SystemConfig.js` - 添加配置读取
3. `backend/controllers/configController.js` - 添加验证和保护
4. `backend/controllers/processController.js` - 使用配置替代硬编码
5. `backend/controllers/costController.js` - 使用配置替代硬编码

### 前端文件
1. `frontend/src/store/config.js` - 新建配置 store
2. `frontend/src/views/SystemConfig.vue` - 添加工价系数配置项
3. `frontend/src/views/ProcessManagement.vue` - 使用配置
4. `frontend/src/views/cost/CostDetail.vue` - 使用配置
5. `frontend/src/views/cost/CostAdd.vue` - 使用配置

## 测试验证

### 1. 数据库验证
```bash
node backend/scripts/checkConfig.js
```
确认 `process_coefficient` 配置项存在且值为 1.56

### 2. 后端验证
- 启动后端服务
- 访问 `/api/config` 接口，确认返回包含 `process_coefficient`
- 创建报价单，验证工序总价计算正确

### 3. 前端验证
- 启动前端服务
- 访问工序管理页面，查看工序总价显示
- 访问报价单详情页面，查看工序总计显示
- 访问报价单新增页面，验证工序总计计算

## 配置管理

### 查看当前配置
```sql
SELECT * FROM system_config WHERE config_key = 'process_coefficient';
```

### 修改配置
通过系统配置页面或 API 修改：
```bash
PUT /api/config/process_coefficient
{
  "value": 1.56
}
```

## 扩展性说明

如果未来需要更灵活的配置（如不同型号或客户使用不同系数），可以：
1. 在 `models` 表中新增 `process_coefficient` 字段
2. 在 `customers` 表中新增 `process_coefficient` 字段
3. 优先级：客户配置 > 型号配置 > 系统默认配置

## 注意事项

1. **数据一致性**：修改工价系数后，历史报价单不会自动更新，只影响新创建的报价单
2. **配置验证**：工价系数必须是正数，建议范围在 1.0 - 3.0 之间
3. **前端缓存**：配置 store 会缓存配置，页面刷新后会重新加载
4. **权限控制**：只有管理员可以修改系统配置

## 完成状态
✅ 数据库配置已添加
✅ 后端代码已修改
✅ 前端代码已修改
✅ 文档已更新
