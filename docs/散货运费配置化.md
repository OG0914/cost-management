# 散货（LCL）运费配置化

## 功能说明

将散货（LCL）运费计算中的各项费用参数从硬编码改为系统配置，使其可以通过系统配置页面灵活调整，无需修改代码。

## 背景

在之前的实现中，散货运费的各项费用参数（基础运费、操作费、拼箱费、文件费）都是硬编码在前端代码中的固定值。这些参数在实际业务中可能会随市场变化而调整，硬编码的方式不够灵活，每次调整都需要修改代码并重新部署。

## 改进内容

### 1. 新增配置项

在系统配置表中新增以下配置项：

| 配置键 | 默认值 | 说明 |
|--------|--------|------|
| `lcl_base_freight_1_3` | 800 | 散货基础运费：1-3 CBM（人民币） |
| `lcl_base_freight_4_10` | 1000 | 散货基础运费：4-10 CBM（人民币） |
| `lcl_base_freight_11_15` | 1500 | 散货基础运费：11-15 CBM（人民币） |
| `lcl_handling_charge` | 500 | 散货操作费（Handling charge）（人民币） |
| `lcl_cfs_per_cbm` | 170 | 散货拼箱费（CFS）每CBM单价（人民币） |
| `lcl_document_fee` | 500 | 散货文件费（人民币） |

### 2. 散货运费计算逻辑

**基础运费（按CBM区间）：**
- 1-3 CBM：使用 `lcl_base_freight_1_3`
- 4-10 CBM：使用 `lcl_base_freight_4_10`
- 11-15 CBM：使用 `lcl_base_freight_11_15`
- 超过15 CBM：提示用户选择整柜运输

**总运费计算公式：**
```
总运费 = 基础运费 + 操作费 + (拼箱费单价 × 向上取整的CBM) + 文件费
```

**示例：**
假设 CBM = 4.5
- 向上取整的CBM = 5
- 基础运费 = 1000（4-10 CBM区间）
- 操作费 = 500
- 拼箱费 = 170 × 5 = 850
- 文件费 = 500
- **总运费 = 1000 + 500 + 850 + 500 = 2850元**

## 实现细节

### 1. 数据库迁移

**文件：** `backend/db/migrations/010_add_lcl_freight_config.sql`

```sql
-- 添加散货（LCL）运费配置项
INSERT OR IGNORE INTO system_config (config_key, config_value, description) 
VALUES ('lcl_base_freight_1_3', '800', '散货基础运费：1-3 CBM（人民币）');

INSERT OR IGNORE INTO system_config (config_key, config_value, description) 
VALUES ('lcl_base_freight_4_10', '1000', '散货基础运费：4-10 CBM（人民币）');

-- ... 其他配置项
```

**执行脚本：** `backend/scripts/run-migration-010.js`

### 2. 后端模型更新

**文件：** `backend/models/SystemConfig.js`

在 `getCalculatorConfig()` 方法中添加散货运费配置的读取：

```javascript
static getCalculatorConfig() {
  return {
    // ... 其他配置
    lclBaseFreight1_3: parseFloat(this.getValue('lcl_base_freight_1_3')) || 800,
    lclBaseFreight4_10: parseFloat(this.getValue('lcl_base_freight_4_10')) || 1000,
    lclBaseFreight11_15: parseFloat(this.getValue('lcl_base_freight_11_15')) || 1500,
    lclHandlingCharge: parseFloat(this.getValue('lcl_handling_charge')) || 500,
    lclCfsPerCbm: parseFloat(this.getValue('lcl_cfs_per_cbm')) || 170,
    lclDocumentFee: parseFloat(this.getValue('lcl_document_fee')) || 500,
    // ...
  };
}
```

### 3. 前端配置页面

**文件：** `frontend/src/views/SystemConfig.vue`

添加散货运费配置的管理界面：

```vue
<!-- 散货运费配置 -->
<el-divider content-position="left">散货（LCL）运费配置</el-divider>

<!-- 基础运费 1-3 CBM -->
<el-form-item label="基础运费（1-3 CBM）">
  <el-input-number
    v-model="configForm.lcl_base_freight_1_3"
    :min="0"
    :step="50"
    :precision="0"
    style="width: 200px"
  />
  <span class="config-hint">（默认 ¥800）</span>
</el-form-item>

<!-- ... 其他配置项 -->
```

### 4. 前端报价单页面

**文件：** `frontend/src/views/cost/CostAdd.vue`

#### 4.1 系统配置状态

```javascript
const systemConfig = ref({
  // ... 其他配置
  lclBaseFreight1_3: 800,
  lclBaseFreight4_10: 1000,
  lclBaseFreight11_15: 1500,
  lclHandlingCharge: 500,
  lclCfsPerCbm: 170,
  lclDocumentFee: 500
})
```

#### 4.2 加载系统配置

```javascript
const loadSystemConfig = async () => {
  try {
    const response = await request.get('/config')
    if (response.success && response.data) {
      // ... 其他配置
      systemConfig.value.lclBaseFreight1_3 = response.data.lcl_base_freight_1_3 || 800
      systemConfig.value.lclBaseFreight4_10 = response.data.lcl_base_freight_4_10 || 1000
      systemConfig.value.lclBaseFreight11_15 = response.data.lcl_base_freight_11_15 || 1500
      systemConfig.value.lclHandlingCharge = response.data.lcl_handling_charge || 500
      systemConfig.value.lclCfsPerCbm = response.data.lcl_cfs_per_cbm || 170
      systemConfig.value.lclDocumentFee = response.data.lcl_document_fee || 500
    }
  } catch (error) {
    console.error('加载系统配置失败:', error)
  }
}
```

#### 4.3 散货运费计算

```javascript
// 基础运费（从系统配置读取）
let baseFreight = 0
if (ceiledCBM >= 1 && ceiledCBM <= 3) {
  baseFreight = systemConfig.value.lclBaseFreight1_3
} else if (ceiledCBM > 3 && ceiledCBM <= 10) {
  baseFreight = systemConfig.value.lclBaseFreight4_10
} else if (ceiledCBM > 10 && ceiledCBM <= 15) {
  baseFreight = systemConfig.value.lclBaseFreight11_15
}

// 固定费用（从系统配置读取）
const handlingCharge = systemConfig.value.lclHandlingCharge
const cfs = systemConfig.value.lclCfsPerCbm * ceiledCBM
const documentFee = systemConfig.value.lclDocumentFee

// 总运费
const totalFreight = baseFreight + handlingCharge + cfs + documentFee
```

## 使用方法

### 1. 查看当前配置

1. 登录系统（需要管理员权限）
2. 进入"系统配置管理"页面
3. 滚动到"散货（LCL）运费配置"部分
4. 查看当前各项费用的配置值

### 2. 修改配置

1. 在系统配置页面修改相应的配置项
2. 点击"保存配置"按钮
3. 配置立即生效，影响新创建的报价单

### 3. 配置生效范围

- **新报价单**：使用最新的配置值计算运费
- **历史报价单**：保留创建时的运费计算结果，不受配置变更影响

## 优势

### 1. 灵活性
- 无需修改代码即可调整运费参数
- 适应市场变化，快速响应价格调整

### 2. 可维护性
- 配置集中管理，便于查看和修改
- 减少代码硬编码，降低维护成本

### 3. 可追溯性
- 配置变更有时间戳记录
- 历史报价单保留创建时的配置，便于追溯

### 4. 用户友好
- 管理员可通过界面直接修改，无需技术支持
- 配置项有清晰的说明和默认值提示

## 注意事项

1. **权限控制**：只有管理员可以修改系统配置
2. **配置验证**：输入值必须为非负数
3. **默认值**：如果配置项不存在或读取失败，使用代码中的默认值
4. **历史数据**：修改配置不影响已创建的报价单
5. **CBM限制**：超过15 CBM的散货会提示用户选择整柜运输

## 相关文件

### 后端
- `backend/db/migrations/010_add_lcl_freight_config.sql` - 数据库迁移文件
- `backend/scripts/run-migration-010.js` - 迁移执行脚本
- `backend/models/SystemConfig.js` - 系统配置模型
- `backend/controllers/configController.js` - 配置控制器

### 前端
- `frontend/src/views/SystemConfig.vue` - 系统配置管理页面
- `frontend/src/views/cost/CostAdd.vue` - 报价单新增/编辑页面

## 测试建议

### 测试用例 1：配置读取
1. 启动系统，进入系统配置页面
2. 验证散货运费配置项是否正确显示
3. 验证默认值是否正确

### 测试用例 2：配置修改
1. 修改某个配置项（如基础运费 1-3 CBM 改为 900）
2. 保存配置
3. 刷新页面，验证配置是否保存成功

### 测试用例 3：运费计算
1. 创建新报价单，选择散货运输
2. 输入数量，触发运费计算
3. 验证运费计算是否使用了最新的配置值

### 测试用例 4：历史数据
1. 修改配置前创建一个报价单
2. 修改配置
3. 查看之前创建的报价单，验证运费是否保持不变

## 后续优化建议

1. **配置历史记录**：记录配置的修改历史，便于审计
2. **批量导入导出**：支持配置的批量导入导出功能
3. **配置模板**：支持保存多套配置模板，快速切换
4. **权限细化**：支持更细粒度的配置权限控制
5. **配置预览**：修改配置前可以预览对报价的影响

## 更新日期

2024-11-30
