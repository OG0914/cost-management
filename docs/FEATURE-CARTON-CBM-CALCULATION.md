# 箱数和CBM自动计算功能

## 功能说明

在新增报价单和查看报价单详情页面，系统会自动根据包装方式和购买数量计算并显示箱数和CBM（立方米）。

## 计算公式

### 1. 每箱只数
```
每箱只数 = 每袋只数 × 每盒袋数 × 每箱盒数
```

**示例：** 1只/袋，10袋/盒，12盒/箱
```
每箱只数 = 1 × 10 × 12 = 120只/箱
```

### 2. 箱数
```
箱数 = 购买数量 ÷ 每箱只数（向上取整）
```

**示例：** 购买数量 4560只
```
箱数 = 4560 ÷ 120 = 38箱
```

### 3. CBM（立方米）
```
总材积 = 外箱材积 × 箱数
CBM = 总材积 ÷ 35.32（保留一位小数）
```

**示例：** 外箱材积 1.68m³，箱数 38箱
```
总材积 = 1.68 × 38 = 63.84m³
CBM = 63.84 ÷ 35.32 = 1.8
```

## 显示规则

1. **箱数字段**：
   - 仅在选择了包装配置且输入了购买数量后显示
   - 显示为只读字段，不可编辑
   - 自动计算并实时更新

2. **CBM字段**：
   - 仅在选择了包装配置、输入了购买数量，且包材中有外箱材积数据时显示
   - 显示为只读字段，不可编辑
   - 自动计算并实时更新
   - 保留一位小数

## 数据来源

### 包装配置信息
从 `packaging_configs` 表获取：
- `pc_per_bag`：每袋只数
- `bags_per_box`：每盒袋数
- `boxes_per_carton`：每箱盒数

### 外箱材积
从 `packaging_materials` 表获取：
- `carton_volume`：外箱材积（立方米）
- 系统会自动查找该包装配置下第一个有外箱材积数据的包材

## 前端实现

### 文件修改
- `frontend/src/views/cost/CostAdd.vue`

### 新增数据结构
```javascript
const shippingInfo = reactive({
  cartons: null,        // 箱数
  cbm: null,            // CBM
  cartonVolume: null,   // 外箱材积
  pcsPerCarton: null    // 每箱只数
})
```

### 计算函数
```javascript
const calculateShippingInfo = () => {
  // 计算箱数
  const cartons = Math.ceil(form.quantity / shippingInfo.pcsPerCarton)
  
  // 计算CBM
  const totalVolume = shippingInfo.cartonVolume * cartons
  const cbm = (totalVolume / 35.32).toFixed(1)
}
```

### 触发时机
1. **新增模式**：选择包装配置时、修改购买数量时
2. **编辑模式**：加载报价单数据时、修改购买数量时
3. **复制模式**：加载报价单数据时、修改购买数量时

## 使用流程

### 新增报价单
1. 用户选择法规类别
2. 用户选择型号配置（包装方式）
3. 系统自动获取包装配置信息和外箱材积
4. 用户输入购买数量
5. 系统自动计算并显示箱数和CBM

### 编辑报价单
1. 系统加载报价单数据
2. 从报价单中获取包装配置信息（pc_per_bag, bags_per_box, boxes_per_carton）
3. 从包材明细中获取外箱材积
4. 自动计算并显示箱数和CBM
5. 用户修改购买数量时，实时更新计算结果

## 注意事项

- 箱数计算使用向上取整，确保数量足够
- CBM计算使用固定系数 35.32
- 如果包材中没有外箱材积数据，则不显示CBM字段
- 这些字段仅用于显示，不会保存到数据库
- 修改购买数量时会实时更新计算结果

## 报价单详情页显示

在报价单详情页面，系统会自动计算并显示箱数和CBM：

### 前端实现
- `frontend/src/views/cost/CostDetail.vue`
- 移除了创建时间、提交时间、审核时间字段
- 添加了箱数和CBM字段（仅在有数据时显示）

### 后端实现
- `backend/models/QuotationItem.js`
- 修改 `findByQuotationIdAndCategory` 方法
- 在查询包材明细时，关联 `packaging_materials` 表获取外箱材积
- 通过 `packaging_config_id` 和 `material_name` 进行匹配

### 计算逻辑
详情页的计算逻辑与新增页面相同：
1. 从报价单获取包装配置信息（pc_per_bag, bags_per_box, boxes_per_carton）
2. 计算每箱只数
3. 根据购买数量计算箱数
4. 从包材明细中查找外箱材积
5. 计算CBM

## 示例场景

### 场景1：完整计算
- 包装方式：1只/袋，10袋/盒，12盒/箱
- 外箱材积：1.68m³
- 购买数量：4560只

**计算结果：**
- 每箱只数：120只
- 箱数：38箱
- 总材积：63.84m³
- CBM：1.8

### 场景2：无外箱材积
- 包装方式：2只/袋，5袋/盒，10盒/箱
- 外箱材积：无
- 购买数量：1000只

**计算结果：**
- 每箱只数：100只
- 箱数：10箱
- CBM：不显示（因为没有外箱材积数据）
