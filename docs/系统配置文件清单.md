# 系统配置文件清单

## 概述

本文档列出了系统配置功能相关的所有前后端文件，便于开发和维护。

## 前端文件

### 1. 系统配置页面
**文件路径：** `frontend/src/views/SystemConfig.vue`

**功能：**
- 显示所有系统配置项
- 提供配置项的编辑界面
- 管理员权限控制
- 配置保存和验证

**配置项包括：**
- 管销率（overhead_rate）
- 增值税率（vat_rate）
- 保险率（insurance_rate）
- 汇率（exchange_rate）
- FOB深圳运费汇率（fob_shenzhen_exchange_rate）
- 20尺整柜运费（fcl_20_freight_usd）
- 40尺整柜运费（fcl_40_freight_usd）
- 利润区间（profit_tiers）

**关键方法：**
- `loadConfig()` - 加载配置
- `handleSave()` - 保存配置
- `addProfitTier()` - 添加利润档位
- `removeProfitTier()` - 删除利润档位

---

## 后端文件

### 1. 配置路由
**文件路径：** `backend/routes/configRoutes.js`

**功能：**
- 定义配置相关的API路由
- 权限验证中间件

**路由列表：**
```javascript
GET    /api/config              // 获取所有配置
GET    /api/config/:key         // 获取单个配置
PUT    /api/config/:key         // 更新单个配置
POST   /api/config/batch        // 批量更新配置
POST   /api/config              // 创建新配置
DELETE /api/config/:key         // 删除配置
GET    /api/config/calculator   // 获取计算器配置
```

**权限要求：**
- 所有路由需要登录（verifyToken）
- 修改操作需要管理员权限（checkRole(['admin'])）

---

### 2. 配置控制器
**文件路径：** `backend/controllers/configController.js`

**功能：**
- 处理配置相关的业务逻辑
- 调用模型层方法
- 返回统一格式的响应

**主要方法：**
- `getAllConfigs(req, res, next)` - 获取所有配置
- `getConfigByKey(req, res, next)` - 获取单个配置
- `updateConfig(req, res, next)` - 更新单个配置
- `batchUpdateConfigs(req, res, next)` - 批量更新配置
- `createConfig(req, res, next)` - 创建新配置
- `deleteConfig(req, res, next)` - 删除配置
- `getCalculatorConfig(req, res, next)` - 获取计算器配置

---

### 3. 配置模型
**文件路径：** `backend/models/SystemConfig.js`

**功能：**
- 数据库操作封装
- 配置数据的CRUD操作
- 配置格式转换

**主要方法：**
- `findAll()` - 查询所有配置
- `findByKey(key)` - 根据键查询配置
- `getAllAsObject()` - 获取所有配置（对象格式）
- `update(key, value)` - 更新配置
- `batchUpdate(configs)` - 批量更新配置
- `create({ key, value, description })` - 创建配置
- `delete(key)` - 删除配置
- `getCalculatorConfig()` - 获取计算器配置（格式化）

**数据格式转换：**
```javascript
// 数据库格式
{
  config_key: 'overhead_rate',
  config_value: '0.2',
  description: '管销率',
  updated_at: '2025-11-13 10:00:00'
}

// API返回格式
{
  overhead_rate: 0.2,
  vat_rate: 0.13,
  exchange_rate: 7.2,
  ...
}
```

---

## 数据库文件

### 1. 初始数据
**文件路径：** `backend/db/seedData.sql`

**功能：**
- 创建 system_config 表
- 插入默认配置数据

**表结构：**
```sql
CREATE TABLE IF NOT EXISTS system_config (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  config_key TEXT NOT NULL UNIQUE,
  config_value TEXT NOT NULL,
  description TEXT,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

---

### 2. 配置相关迁移文件

#### 迁移1：FOB深圳运费汇率
**文件路径：** `backend/db/migrations/007_add_fob_shenzhen_exchange_rate.sql`

**功能：**
- 添加 fob_shenzhen_exchange_rate 配置项
- 默认值：7.1

#### 迁移2：整柜运费配置
**文件路径：** `backend/db/migrations/009_add_fcl_freight_config.sql`

**功能：**
- 添加 fcl_20_freight_usd 配置项（默认$840）
- 添加 fcl_40_freight_usd 配置项（默认$940）

---

## 工具脚本

### 1. 配置检查脚本
**文件路径：** `backend/scripts/checkConfig.js`

**功能：**
- 查看当前所有系统配置
- 用于调试和验证

**使用方法：**
```bash
node backend/scripts/checkConfig.js
```

---

### 2. FOB配置测试脚本
**文件路径：** `backend/scripts/testFobConfig.js`

**功能：**
- 测试FOB深圳运费配置
- 验证运费计算逻辑

**使用方法：**
```bash
node backend/scripts/testFobConfig.js
```

---

## 配置使用示例

### 前端获取配置

```javascript
// 在组件中加载配置
const loadSystemConfig = async () => {
  try {
    const response = await request.get('/config')
    if (response.success && response.data) {
      systemConfig.value.fobShenzhenExchangeRate = response.data.fob_shenzhen_exchange_rate || 7.1
      systemConfig.value.fcl20FreightUsd = response.data.fcl_20_freight_usd || 840
      systemConfig.value.fcl40FreightUsd = response.data.fcl_40_freight_usd || 940
    }
  } catch (error) {
    console.error('加载系统配置失败:', error)
  }
}
```

---

### 后端使用配置

```javascript
// 在控制器中使用配置
const SystemConfig = require('../models/SystemConfig');

// 获取所有配置（对象格式）
const configs = SystemConfig.getAllAsObject();
console.log(configs.overhead_rate); // 0.2

// 获取计算器配置（格式化后）
const calculatorConfig = SystemConfig.getCalculatorConfig();
const calculator = new CostCalculator(calculatorConfig);
```

---

## 配置项说明

### 1. 成本计算相关

| 配置键 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| overhead_rate | Number | 0.2 | 管销率（20%） |
| vat_rate | Number | 0.13 | 增值税率（13%） |
| insurance_rate | Number | 0.003 | 保险率（0.3%） |
| exchange_rate | Number | 7.2 | 汇率（CNY/USD） |

### 2. 运费相关

| 配置键 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| fob_shenzhen_exchange_rate | Number | 7.1 | FOB深圳运费汇率（USD/CNY） |
| fcl_20_freight_usd | Number | 840 | 20尺整柜运费（美金） |
| fcl_40_freight_usd | Number | 940 | 40尺整柜运费（美金） |

### 3. 利润相关

| 配置键 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| profit_tiers | Array | [0.05, 0.10, 0.25, 0.50] | 利润区间（5%, 10%, 25%, 50%） |

---

## 权限控制

### 查看权限
- 所有登录用户可以查看配置

### 修改权限
- 只有管理员（admin）可以修改配置
- 前端通过 `authStore.isAdmin` 控制界面显示
- 后端通过 `checkRole(['admin'])` 中间件验证

---

## 配置修改流程

1. **前端操作**
   - 管理员登录系统
   - 进入"系统配置管理"页面
   - 修改配置值
   - 点击"保存配置"按钮

2. **后端处理**
   - 验证用户权限（必须是管理员）
   - 验证配置值的合法性
   - 批量更新数据库
   - 返回成功响应

3. **生效时间**
   - 配置修改立即生效
   - 新创建的报价单使用新配置
   - 历史报价单保留创建时的配置

---

## 注意事项

1. **数据类型转换**
   - 数据库中所有配置值存储为 TEXT 类型
   - 读取时需要转换为对应的数据类型（Number, Array等）
   - profit_tiers 存储为 JSON 字符串

2. **默认值处理**
   - 所有配置读取时都应提供默认值
   - 防止配置项不存在时导致错误

3. **权限验证**
   - 所有修改操作必须验证管理员权限
   - 前后端都要进行权限检查

4. **配置验证**
   - 保存前验证配置值的合法性
   - 如：管销率必须在0-1之间

---

## 相关文档

- [更新-整柜运费配置化](./更新-整柜运费配置化.md)
- [更新-FOB深圳运费汇率配置](./更新-FOB深圳运费汇率配置.md)
- [硬编码检查报告](./硬编码检查报告.md)

---

## 文件依赖关系

```
前端
└── SystemConfig.vue
    └── request.get('/config')
        └── 后端 API

后端
├── server.js
│   └── /api/config -> configRoutes.js
│       └── configController.js
│           └── SystemConfig.js (Model)
│               └── database.js
│                   └── cost_analysis.db
│
└── 其他控制器
    └── costController.js
        └── SystemConfig.getCalculatorConfig()
```

---

## 快速定位

### 需要修改配置项？
→ `frontend/src/views/SystemConfig.vue`

### 需要添加新的配置项？
1. 创建数据库迁移文件
2. 更新 `SystemConfig.vue` 添加输入框
3. 更新 `SystemConfig.js` 的 `getCalculatorConfig()` 方法（如果需要）

### 需要在其他地方使用配置？
→ 调用 `SystemConfig.getAllAsObject()` 或 `SystemConfig.getCalculatorConfig()`

### 需要调试配置？
→ 运行 `node backend/scripts/checkConfig.js`
