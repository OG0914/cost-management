# 管销后算功能说明

## 功能概述

"管销后算"是一个新增的成本计算功能，允许用户将某些原料的成本在管销价计算完成后再加入，而不是在基础成本价阶段就计入。

## 使用场景

某些特殊原料（如特定的包装材料、标签等）可能需要在管销价计算后再加入成本，以便更准确地反映实际成本结构。

## 功能位置

在"新增/编辑报价单"页面的"原料明细"表格中：
- 在序号列左侧新增了"管销后算"列
- 每行原料都有一个复选框，可以勾选是否启用管销后算

## 计算逻辑

### 传统计算方式（不勾选管销后算）

```
基础成本价 = 原料总价 + 工价总价 + 包材总价 + 运费
管销价 = 基础成本价 ÷ (1 - 管销率)
最终成本价 = 管销价 × (1 + 增值税率)  // 内销
最终成本价 = 管销价 ÷ 汇率 × (1 + 保险率)  // 外销
```

### 管销后算方式（勾选管销后算）

```
基础成本价 = 原料总价（不含管销后算的原料） + 工价总价 + 包材总价 + 运费
管销价 = 基础成本价 ÷ (1 - 管销率)
最终成本价 = 管销价 × (1 + 增值税率) + 管销后算的原料总价  // 内销
最终成本价 = 管销价 ÷ 汇率 × (1 + 保险率) + 管销后算的原料总价  // 外销
```

## 操作步骤

1. 在"新增报价单"页面，选择法规类别和型号配置
2. 在"原料明细"表格中，找到需要管销后算的原料
3. 勾选该原料行左侧的"管销后算"复选框
4. 系统会自动重新计算成本，将勾选的原料从基础成本价中移除
5. 在成本计算结果中，会显示"管销后算原料"的金额
6. 最终成本价会在管销价基础上加上管销后算的原料金额

## 界面显示

### 原料明细表格
- 新增"管销后算"列（带提示图标）
- 勾选框可以启用/禁用管销后算功能
- 标准数据在锁定状态下不可修改勾选状态

### 原料总计显示
```
原料总计（管销前）：XXX.XX    管销后算：XXX.XX
```
- 左侧显示参与基础成本价计算的原料总计
- 右侧显示管销后算的原料总计（橙色显示）

### 成本计算结果
在成本计算卡片中，如果有管销后算的原料，会显示：
```
管销后算原料：XXX.XX（橙色加粗显示）
```

## 数据库变更

### 新增字段
在 `quotation_items` 表中新增字段：
- `after_overhead` (BOOLEAN, 默认值: 0)
  - 0: 正常计算（计入基础成本价）
  - 1: 管销后算（在管销价后加入）

### 数据迁移
已提供迁移脚本：`backend/scripts/migrate-after-overhead.js`

运行方式：
```bash
node backend/scripts/migrate-after-overhead.js
```

## 注意事项

1. 管销后算功能仅适用于原料明细，不适用于工序和包材
2. 勾选管销后算后，该原料不会计入基础成本价和管销价的计算
3. 在编辑模式下，标准数据需要先解锁才能修改管销后算状态
4. 管销后算的原料金额会在最终成本价中单独显示
5. 利润区间报价基于包含管销后算原料的最终成本价计算

## 技术实现

### 后端
- `backend/models/QuotationItem.js`: 支持 `after_overhead` 字段的读写
- `backend/utils/costCalculator.js`: 更新计算逻辑，支持管销后算
- `backend/controllers/costController.js`: 分离管销前后的原料总计

### 前端
- `frontend/src/views/cost/CostAdd.vue`: 
  - 新增管销后算复选框列
  - 分离显示管销前后的原料总计
  - 在成本计算结果中显示管销后算原料金额

## 测试建议

1. 创建新报价单，勾选部分原料为管销后算
2. 验证原料总计分离显示是否正确
3. 验证成本计算结果是否正确
4. 保存并重新打开，验证管销后算状态是否保存
5. 测试编辑模式下的解锁/锁定功能
6. 测试复制报价单时管销后算状态是否正确复制
