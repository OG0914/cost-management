# 更新：整柜运费配置化

## 更新日期
2025-11-13

## 问题描述

之前的整柜运费（20尺整柜$840、40尺整柜$940）是硬编码在前端代码中的，无法通过系统配置灵活调整。这导致：

1. 运费变动时需要修改代码并重新部署
2. 不同客户或不同时期的运费差异无法灵活处理
3. 配置管理不统一，部分参数可配置，部分参数硬编码

## 解决方案

将整柜运费配置化，添加到系统配置管理中，与其他配置参数（如汇率、管销率等）统一管理。

## 实现内容

### 1. 数据库迁移

**文件：** `backend/db/migrations/009_add_fcl_freight_config.sql`

添加两个新的系统配置项：

```sql
-- 20尺整柜运费（美金）
INSERT OR IGNORE INTO system_config (config_key, config_value, description, updated_at)
VALUES ('fcl_20_freight_usd', '840', '20尺整柜FOB深圳运费（美金）', CURRENT_TIMESTAMP);

-- 40尺整柜运费（美金）
INSERT OR IGNORE INTO system_config (config_key, config_value, description, updated_at)
VALUES ('fcl_40_freight_usd', '940', '40尺整柜FOB深圳运费（美金）', CURRENT_TIMESTAMP);
```

### 2. 系统配置页面更新

**文件：** `frontend/src/views/SystemConfig.vue`

添加两个新的配置项输入框：

- **20尺整柜运费（美金）**：默认 $840
- **40尺整柜运费（美金）**：默认 $940

### 3. 报价单页面更新

**文件：** `frontend/src/views/cost/CostAdd.vue`

**修改前（硬编码）：**
```javascript
const freightUSD = form.shipping_method === 'fcl_40' ? 940 : 840
```

**修改后（配置化）：**
```javascript
const freightUSD = form.shipping_method === 'fcl_40' 
  ? systemConfig.value.fcl40FreightUsd 
  : systemConfig.value.fcl20FreightUsd
```

## 配置说明

### 配置项列表

| 配置项 | 配置键 | 默认值 | 说明 |
|--------|--------|--------|------|
| 20尺整柜运费 | fcl_20_freight_usd | $840 | 20尺整柜FOB深圳的固定运费（美金） |
| 40尺整柜运费 | fcl_40_freight_usd | $940 | 40尺整柜FOB深圳的固定运费（美金） |
| FOB深圳运费汇率 | fob_shenzhen_exchange_rate | 7.1 | 用于将美金运费转换为人民币 |

### 运费计算公式

**20尺整柜：**
```
运费（人民币）= 20尺整柜运费（美金）× FOB深圳运费汇率
默认：$840 × 7.1 = ¥5964
```

**40尺整柜：**
```
运费（人民币）= 40尺整柜运费（美金）× FOB深圳运费汇率
默认：$940 × 7.1 = ¥6674
```

## 使用方法

### 修改整柜运费

1. 以管理员身份登录系统
2. 进入"系统配置管理"页面
3. 找到"20尺整柜运费（美金）"或"40尺整柜运费（美金）"配置项
4. 修改数值（如：将20尺整柜运费从$840改为$850）
5. 点击"保存配置"按钮
6. 新创建的报价单将使用新的运费配置

### 配置示例

**场景1：运费上涨**
- 20尺整柜运费：$840 → $860
- 40尺整柜运费：$940 → $960
- 运费汇率：7.1（不变）

**场景2：汇率变化**
- 20尺整柜运费：$840（不变）
- 40尺整柜运费：$940（不变）
- 运费汇率：7.1 → 7.2

**场景3：同时调整**
- 20尺整柜运费：$840 → $850
- 40尺整柜运费：$940 → $950
- 运费汇率：7.1 → 7.2

## 优势

### 1. 灵活性
- 运费变动时无需修改代码
- 可以快速响应市场变化
- 支持不同时期的运费调整

### 2. 统一管理
- 所有配置参数集中管理
- 配置修改有记录和时间戳
- 便于审计和追溯

### 3. 易维护
- 减少硬编码，提高代码质量
- 降低维护成本
- 减少部署频率

### 4. 用户友好
- 管理员可以通过界面直接修改
- 无需技术人员介入
- 修改立即生效

## 兼容性

### 历史数据
- 已创建的报价单保留创建时的运费金额
- 不会影响历史报价单的数据

### 默认值
- 如果配置项不存在，使用默认值（$840/$940）
- 确保系统在任何情况下都能正常运行

## 注意事项

1. **权限控制**：只有管理员可以修改系统配置
2. **立即生效**：配置修改后，新创建的报价单立即使用新配置
3. **历史保留**：已创建的报价单不受影响
4. **合理范围**：建议运费设置在合理范围内（如$500-$2000）
5. **配合汇率**：运费和汇率应配合调整，确保最终人民币金额合理

## 测试建议

### 测试用例1：修改20尺整柜运费
1. 修改配置：20尺整柜运费 $840 → $850
2. 创建新报价单，选择20尺整柜
3. 验证运费计算：$850 × 7.1 = ¥6035

### 测试用例2：修改40尺整柜运费
1. 修改配置：40尺整柜运费 $940 → $950
2. 创建新报价单，选择40尺整柜
3. 验证运费计算：$950 × 7.1 = ¥6745

### 测试用例3：同时修改运费和汇率
1. 修改配置：
   - 20尺整柜运费 $840 → $850
   - 运费汇率 7.1 → 7.2
2. 创建新报价单，选择20尺整柜
3. 验证运费计算：$850 × 7.2 = ¥6120

## 相关文档

- [更新-40尺和20尺整柜分离](./更新-40尺和20尺整柜分离.md)
- [更新-FOB深圳运费汇率配置](./更新-FOB深圳运费汇率配置.md)
- [整柜FOB深圳自动计算功能说明](./整柜FOB深圳自动计算功能说明.md)
- [FOB运费自动计算-使用说明](./FOB运费自动计算-使用说明.md)

## 更新日志

- **2025-11-13**：将整柜运费从硬编码改为配置化
- **2025-11-13**：添加系统配置页面的运费配置项
- **2025-11-13**：更新报价单页面使用配置值
