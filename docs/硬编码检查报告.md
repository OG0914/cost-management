# 硬编码检查报告

## 检查日期
2025-11-13

## 检查范围
整柜运费相关的硬编码值

## 发现的问题

### 1. 整柜运费硬编码

**位置：** `frontend/src/views/cost/CostAdd.vue`

**问题代码：**
```javascript
const freightUSD = form.shipping_method === 'fcl_40' ? 940 : 840
```

**问题描述：**
- 20尺整柜运费 $840 硬编码
- 40尺整柜运费 $940 硬编码
- 无法通过系统配置灵活调整

### 2. 测试脚本中的硬编码

**位置：** `backend/scripts/testFobConfig.js`

**问题代码：**
```javascript
const freightUSD = 840;
```

**问题描述：**
- 测试脚本中使用硬编码值
- 应该从配置中读取

## 已解决的问题

### 1. 整柜运费配置化

✅ **已完成**

**解决方案：**
1. 创建数据库迁移 `009_add_fcl_freight_config.sql`
2. 添加配置项：
   - `fcl_20_freight_usd`：20尺整柜运费（默认$840）
   - `fcl_40_freight_usd`：40尺整柜运费（默认$940）
3. 更新系统配置页面，添加配置输入框
4. 更新报价单页面，从配置读取运费值

**修改后代码：**
```javascript
const freightUSD = form.shipping_method === 'fcl_40' 
  ? systemConfig.value.fcl40FreightUsd 
  : systemConfig.value.fcl20FreightUsd
```

## 其他硬编码检查

### 1. 容积参数

**位置：** `frontend/src/views/cost/CostAdd.vue`

**代码：**
```javascript
const containerVolume = form.shipping_method === 'fcl_40' ? 1950 : 950
```

**评估：** ✅ 可接受
- 1950立方英尺（40尺整柜）和950立方英尺（20尺整柜）是国际标准
- 这些值基本不会变化
- 暂时保持硬编码，如有需要可以后续配置化

### 2. 散货运费计算参数

**位置：** `frontend/src/views/cost/CostAdd.vue`

**代码：**
```javascript
// 基础运费
if (ceiledCBM >= 1 && ceiledCBM <= 3) {
  baseFreight = 800
} else if (ceiledCBM > 3 && ceiledCBM <= 10) {
  baseFreight = 1000
} else if (ceiledCBM > 10 && ceiledCBM <= 15) {
  baseFreight = 1500
}

// 固定费用
const handlingCharge = 500
const cfs = 170 * ceiledCBM
const documentFee = 500
```

**评估：** ⚠️ 建议配置化
- 散货运费计算涉及多个参数
- 这些参数可能随市场变化
- 建议后续将这些参数配置化

### 3. 工序系数

**位置：** `frontend/src/views/cost/CostAdd.vue`

**代码：**
```javascript
const processTotal = computed(() => {
  const sum = form.processes.reduce((sum, item) => sum + item.subtotal, 0)
  return sum * 1.56
})
```

**评估：** ⚠️ 建议配置化
- 工序系数 1.56 是硬编码
- 这个系数可能需要调整
- 建议后续配置化

### 4. 管销率、增值税率等

**位置：** 系统配置

**评估：** ✅ 已配置化
- 管销率：0.2（20%）
- 增值税率：0.13（13%）
- 保险率：0.003（0.3%）
- 汇率：7.2
- FOB深圳运费汇率：7.1

## 建议的后续优化

### 优先级1：高（建议立即处理）
无

### 优先级2：中（建议近期处理）

1. **散货运费参数配置化**
   - 基础运费阶梯（800/1000/1500）
   - 操作费（500）
   - 拼箱费单价（170/CBM）
   - 文件费（500）

2. **工序系数配置化**
   - 当前硬编码为 1.56
   - 建议添加到系统配置

### 优先级3：低（可选）

1. **容积参数配置化**
   - 20尺整柜容积（950立方英尺）
   - 40尺整柜容积（1950立方英尺）
   - 虽然是国际标准，但配置化可以提高灵活性

## 检查结论

### 已解决
✅ 整柜运费硬编码问题已解决
✅ 系统配置页面已更新
✅ 报价单页面已更新
✅ 数据库迁移已执行

### 待优化
⚠️ 散货运费参数建议配置化
⚠️ 工序系数建议配置化
ℹ️ 容积参数可选配置化

### 总体评价
- 核心硬编码问题已解决
- 系统灵活性显著提升
- 配置管理更加统一
- 维护成本降低

## 测试建议

1. **功能测试**
   - 测试修改20尺整柜运费配置
   - 测试修改40尺整柜运费配置
   - 验证新报价单使用新配置
   - 验证历史报价单不受影响

2. **边界测试**
   - 测试运费为0的情况
   - 测试运费为极大值的情况
   - 测试配置项不存在时的默认值

3. **回归测试**
   - 验证其他功能不受影响
   - 验证散货运费计算正常
   - 验证成本计算正常

## 相关文档

- [更新-整柜运费配置化](./更新-整柜运费配置化.md)
- [更新-40尺和20尺整柜分离](./更新-40尺和20尺整柜分离.md)
- [测试-40尺和20尺整柜功能](./测试-40尺和20尺整柜功能.md)
