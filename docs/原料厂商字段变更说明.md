# 原料厂商字段变更说明

## 变更概述

将原料管理中的"绑定型号"字段改为"厂商"字段，用于记录并区分对应原料的厂商信息。

## 变更原因

在实际业务中，经常遇到同品号从不同厂商采购的情况。原来的"绑定型号"字段无法满足这个需求。改为"厂商"字段后：
- 可以记录原料的供应商信息
- 同品号可以复制一样的，再改对应厂商
- ID是唯一的且被隐藏，不会产生冲突

## 数据库变更

### materials 表结构变更

**变更前：**
```sql
CREATE TABLE materials (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  item_no TEXT NOT NULL UNIQUE,
  name TEXT NOT NULL,
  unit TEXT NOT NULL,
  price REAL NOT NULL,
  currency TEXT NOT NULL DEFAULT 'CNY',
  model_id INTEGER,                          -- 外键，关联 models 表
  usage_amount REAL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (model_id) REFERENCES models(id)
);
```

**变更后：**
```sql
CREATE TABLE materials (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  item_no TEXT NOT NULL UNIQUE,
  name TEXT NOT NULL,
  unit TEXT NOT NULL,
  price REAL NOT NULL,
  currency TEXT NOT NULL DEFAULT 'CNY',
  manufacturer TEXT,                         -- 文本字段，记录厂商名称
  usage_amount REAL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 索引变更

- 删除：`idx_materials_model_id`
- 新增：`idx_materials_manufacturer`

## 后端变更

### 1. 模型层 (backend/models/Material.js)

- `create()` 方法：`model_id` 参数改为 `manufacturer`
- `update()` 方法：`model_id` 参数改为 `manufacturer`
- `batchCreate()` 方法：`model_id` 参数改为 `manufacturer`
- `findAll()` 方法：移除与 models 表的 JOIN 查询
- `findByModelId()` 方法改为 `findByManufacturer()` 方法

### 2. 控制器层 (backend/controllers/materialController.js)

- `createMaterial()`：接收 `manufacturer` 参数
- `updateMaterial()`：接收 `manufacturer` 参数
- `getMaterialsByModel()` 改为 `getMaterialsByManufacturer()`
- 移除品号唯一性检查（允许同品号不同厂商）

### 3. 路由层 (backend/routes/materialRoutes.js)

- `/model/:modelId` 改为 `/manufacturer/:manufacturer`

### 4. Excel 处理 (backend/utils/)

#### excelParser.js
- `parseMaterialExcel()`：解析"厂商"列（可选）
- 支持中英文列名：`厂商` / `manufacturer`

#### excelGenerator.js
- `generateMaterialExcel()`：导出时包含"厂商"列
- `generateMaterialTemplate()`：模板中包含"厂商"列

## 前端变更

### 1. 原料管理页面 (frontend/src/views/material/MaterialManage.vue)

**表格显示：**
- "绑定型号"列改为"厂商"列
- 显示 `row.manufacturer` 而非 `row.model_name`

**表单编辑：**
- 移除型号下拉选择框
- 新增厂商文本输入框
- 表单字段：`form.model_id` 改为 `form.manufacturer`

**数据处理：**
- 移除 `fetchModels()` 方法
- 移除 `models` 响应式变量

### 2. 报价单添加页面 (frontend/src/views/cost/CostAdd.vue)

**原料选择下拉框：**
- 选项标签格式：`原料名称 (品号) - 厂商`
- 选项详情显示：原料名称 + 厂商标签 + 单价
- 增加厂商名称显示，方便区分同品号不同厂商的原料

示例：
```
塑料粒子 (MAT001) - 厂商A    ¥10.5/kg
塑料粒子 (MAT001) - 厂商B    ¥9.8/kg
```

## Excel 模板变更

### 导入模板列结构

**变更前：**
| 品号 | 原料名称 | 单位 | 单价 | 币别 |
|------|---------|------|------|------|

**变更后：**
| 品号 | 原料名称 | 单位 | 单价 | 币别 | 厂商 |
|------|---------|------|------|------|------|

### 导出Excel列结构

**变更前：**
| 品号 | 原料名称 | 单位 | 单价 | 币别 | 更新时间 |
|------|---------|------|------|------|---------|

**变更后：**
| 品号 | 原料名称 | 单位 | 单价 | 币别 | 厂商 | 更新时间 |
|------|---------|------|------|------|------|---------|

## 数据迁移

### 迁移脚本

位置：`backend/scripts/migrate-material-manufacturer.js`

### 迁移步骤

1. 禁用外键约束
2. 创建新的 materials 表结构
3. 迁移数据（将原 model_id 对应的型号名称转为厂商名）
4. 删除旧表
5. 重命名新表
6. 重建索引
7. 重新启用外键约束

### 执行迁移

```bash
node backend/scripts/migrate-material-manufacturer.js
```

### 迁移结果

- 原有数据保留
- 原来绑定的型号名称转换为厂商名称
- 未绑定型号的原料，厂商字段为空

## 兼容性说明

### 数据兼容性

- ✅ 原有原料数据完整保留
- ✅ 原有报价单数据不受影响（通过 material_id 关联）
- ✅ 价格历史记录不受影响

### API 兼容性

- ⚠️ 不兼容：`GET /materials/model/:modelId` 改为 `/materials/manufacturer/:manufacturer`
- ✅ 兼容：其他所有 API 端点保持不变
- ✅ 兼容：请求/响应数据结构保持一致（仅字段名变更）

## 使用示例

### 1. 添加原料（同品号不同厂商）

```javascript
// 厂商A的原料
{
  item_no: 'MAT001',
  name: '塑料粒子',
  unit: 'kg',
  price: 10.5,
  currency: 'CNY',
  manufacturer: '厂商A'
}

// 厂商B的原料（品号相同）
{
  item_no: 'MAT001',
  name: '塑料粒子',
  unit: 'kg',
  price: 9.8,
  currency: 'CNY',
  manufacturer: '厂商B'
}
```

### 2. Excel 导入示例

| 品号 | 原料名称 | 单位 | 单价 | 币别 | 厂商 |
|------|---------|------|------|------|------|
| MAT001 | 塑料粒子 | kg | 10.5 | CNY | 厂商A |
| MAT001 | 塑料粒子 | kg | 9.8 | CNY | 厂商B |
| MAT002 | 铝合金 | kg | 25.0 | CNY | 厂商C |

### 3. 报价单中选择原料

在报价单添加页面，原料下拉框会显示：
```
塑料粒子 (MAT001) - 厂商A    ¥10.5/kg
塑料粒子 (MAT001) - 厂商B    ¥9.8/kg
铝合金 (MAT002) - 厂商C      ¥25.0/kg
```

## 注意事项

1. **品号不再唯一**：同一品号可以对应多个厂商，通过 ID 区分
2. **厂商字段可选**：厂商字段可以为空，不影响原料的正常使用
3. **Excel 导入**：导入时如果品号相同但厂商不同，会创建新记录而非更新
4. **数据备份**：执行迁移前建议备份数据库文件

## 测试建议

1. 测试原料的增删改查功能
2. 测试同品号不同厂商的原料创建
3. 测试 Excel 导入导出功能
4. 测试报价单中原料选择功能
5. 验证原有报价单数据完整性

## 回滚方案

如需回滚，可以：
1. 恢复数据库备份
2. 或执行反向迁移脚本（将 manufacturer 改回 model_id）

注意：回滚会丢失迁移后新增的数据。

## 变更日期

2024-12-02

## 变更人员

系统管理员
