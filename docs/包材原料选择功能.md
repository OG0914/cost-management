# 包材原料选择功能

## 功能概述

在包材管理页面的包材列表中，为"包材名称"字段添加了自动完成搜索功能，用户可以通过输入关键字从原料库中快速选择原料，并自动填充单价。

## 功能特性

### 1. 自动完成搜索

- **输入关键字**：在包材名称栏位输入关键字
- **实时搜索**：支持按原料名称或品号搜索
- **模糊匹配**：不区分大小写，支持部分匹配
- **结果限制**：最多显示20条匹配结果

### 2. 搜索范围

搜索会匹配以下字段：
- 原料名称（name）
- 原料品号（item_no）

### 3. 自动填充

选择原料后，系统会自动：
- 填充包材名称为原料名称
- 填充单价为原料价格

### 4. 下拉列表显示

每个原料选项显示：
- **左侧**：原料名称（加粗显示）
- **右侧**：单价和单位（灰色小字）

示例：
```
原料A                    ¥12.50/kg
原料B                    ¥8.30/个
```

## 使用场景

### 场景1：新增包材配置

1. 点击"新增包装配置"
2. 填写基本信息
3. 点击"添加包材"
4. 在包材名称栏位输入关键字（如"纸箱"）
5. 从下拉列表选择对应的原料
6. 系统自动填充单价
7. 手动输入基本用量和外箱材积
8. 保存

### 场景2：编辑包材配置

1. 点击"编辑"按钮
2. 在包材列表中修改包材名称
3. 输入关键字搜索原料
4. 选择后自动更新单价
5. 保存

### 场景3：复制包材配置

1. 点击"复制"按钮
2. 修改配置名称
3. 在包材列表中可以重新选择原料
4. 删除不需要的包材行
5. 保存

## 技术实现

### 前端实现

#### 1. 组件替换

将原来的 `el-input` 替换为 `el-autocomplete`：

```vue
<el-autocomplete
  v-model="row.material_name"
  :fetch-suggestions="queryMaterials"
  placeholder="输入关键字搜索原料"
  size="small"
  style="width: 100%"
  @select="(item) => handleSelectMaterial(row, item)"
  clearable
>
  <template #default="{ item }">
    <div class="material-option">
      <span class="material-name">{{ item.name }}</span>
      <span class="material-price">¥{{ formatNumber(item.price) }}/{{ item.unit }}</span>
    </div>
  </template>
</el-autocomplete>
```

#### 2. 数据加载

在页面加载时获取所有原料：

```javascript
const allMaterials = ref([]);

const loadMaterials = async () => {
  try {
    const response = await request.get('/materials');
    if (response.success) {
      allMaterials.value = response.data;
    }
  } catch (error) {
    console.error('加载原料失败:', error);
  }
};
```

#### 3. 搜索逻辑

```javascript
const queryMaterials = (queryString, cb) => {
  if (!queryString) {
    cb(allMaterials.value.slice(0, 20)); // 默认显示前20条
    return;
  }
  
  const results = allMaterials.value.filter(material => {
    const query = queryString.toLowerCase();
    return (
      material.name.toLowerCase().includes(query) ||
      material.item_no.toLowerCase().includes(query)
    );
  });
  
  cb(results.slice(0, 20)); // 最多显示20条结果
};
```

#### 4. 选择处理

```javascript
const handleSelectMaterial = (row, material) => {
  row.material_name = material.name;
  row.unit_price = material.price;
};
```

### 后端接口

使用现有的原料接口：
- `GET /materials` - 获取所有原料列表

## 优势

1. **提高效率**：无需手动输入原料名称和单价
2. **减少错误**：避免输入错误的原料名称或单价
3. **数据一致性**：确保包材使用的原料与原料库一致
4. **用户友好**：支持模糊搜索，快速定位
5. **灵活性**：仍然支持手动输入自定义包材名称

## 注意事项

1. **手动输入**：如果不从列表选择，仍然可以手动输入包材名称和单价
2. **单价更新**：选择原料后，单价会自动填充，但可以手动修改
3. **原料同步**：如果原料库中的价格更新，需要重新选择原料才能获取最新价格
4. **性能优化**：原料列表在页面加载时一次性获取，避免频繁请求

## 未来优化建议

1. **按型号筛选**：根据当前选择的型号，优先显示该型号关联的原料
2. **最近使用**：记录最近使用的原料，优先显示
3. **收藏功能**：允许用户收藏常用原料
4. **批量导入**：支持从Excel导入时自动匹配原料
5. **价格提醒**：当原料价格变动时，提醒用户更新包材配置

## 测试建议

### 测试用例

1. **基本搜索**
   - 输入完整原料名称
   - 输入部分原料名称
   - 输入原料品号
   - 输入不存在的关键字

2. **选择功能**
   - 选择原料后检查名称和单价是否正确填充
   - 选择后修改单价
   - 清空选择后重新输入

3. **边界情况**
   - 原料库为空
   - 原料数量超过20条
   - 包含特殊字符的原料名称

4. **兼容性**
   - 新增配置时使用
   - 编辑配置时使用
   - 复制配置时使用

## 总结

通过添加原料选择功能，包材管理变得更加高效和准确。用户可以快速从原料库中选择包材，系统自动填充单价，大大减少了手动输入的工作量和错误率。
