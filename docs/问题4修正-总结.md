# é—®é¢˜4ä¿®æ­£æ€»ç»“

## ä¿®æ­£å†…å®¹
âœ… åˆ›å»ºäº† SQL æŸ¥è¯¢æ„å»ºå™¨ `backend/utils/queryBuilder.js`  
âœ… é‡æ„äº† `backend/models/Quotation.js` çš„ `findAll` æ–¹æ³•  
âœ… ç¼–å†™äº†å®Œæ•´çš„å•å…ƒæµ‹è¯• `backend/utils/queryBuilder.test.js`  
âœ… éªŒè¯äº†æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ  

## æ ¸å¿ƒæ”¹è¿›

### ä¿®æ­£å‰ï¼ˆæ‰‹åŠ¨æ‹¼æ¥ SQLï¼‰
```javascript
let whereClause = [];
let params = [];

if (status) {
  whereClause.push('q.status = ?');
  params.push(status);
}

const whereSQL = whereClause.length > 0 ? 'WHERE ' + whereClause.join(' AND ') : '';
const sql = `SELECT * FROM quotations q ${whereSQL}`;
```

**é—®é¢˜**ï¼š
- å¯è¯»æ€§å·®
- å®¹æ˜“å‡ºé”™
- å­˜åœ¨ SQL æ³¨å…¥é£é™©ï¼ˆå¦‚æœå¿˜è®°ç”¨å ä½ç¬¦ï¼‰

### ä¿®æ­£åï¼ˆä½¿ç”¨æŸ¥è¯¢æ„å»ºå™¨ï¼‰
```javascript
const builder = new QueryBuilder('quotations q')
  .leftJoin('models m', 'q.model_id = m.id')
  .where('q.status', '=', status)
  .whereLike('q.customer_name', customer_name)
  .orderByDesc('q.created_at')
  .limit(pageSize)
  .offset(offset);

const query = builder.buildSelect('q.*, m.model_name');
const data = db.prepare(query.sql).all(...query.params);
```

**ä¼˜åŠ¿**ï¼š
- âœ… ä»£ç æ¸…æ™°æ˜“è¯»
- âœ… é“¾å¼è°ƒç”¨ï¼Œç¬¦åˆç›´è§‰
- âœ… ç»Ÿä¸€çš„å‚æ•°åŒ–æŸ¥è¯¢ï¼Œå®‰å…¨å¯é 
- âœ… å‚æ•°éš”ç¦»ï¼Œé¿å…å‰¯ä½œç”¨

## å…³é”®ç‰¹æ€§

### 1. å‚æ•°éš”ç¦»
`buildSelect` æ–¹æ³•ä½¿ç”¨å±€éƒ¨å˜é‡ç»„åˆå‚æ•°ï¼Œä¸ä¿®æ”¹ `this.params`ï¼š

```javascript
buildSelect(fields = '*') {
  // ä½¿ç”¨å±€éƒ¨å˜é‡ï¼Œä¸ä¿®æ”¹ this.params
  const queryParams = [...this.params];
  
  if (this.limitValue !== null) {
    sql += ' LIMIT ?';
    queryParams.push(this.limitValue);  // åªä¿®æ”¹å±€éƒ¨å˜é‡
  }
  
  return { sql, params: queryParams };
}
```

### 2. æ”¯æŒçš„æŸ¥è¯¢æ“ä½œ
- `where(field, operator, value)` - åŸºæœ¬æ¡ä»¶
- `whereLike(field, value)` - æ¨¡ç³ŠæŸ¥è¯¢
- `whereIn(field, values)` - IN æŸ¥è¯¢
- `whereDate(field, operator, date)` - æ—¥æœŸæ¡ä»¶
- `leftJoin(table, condition)` - LEFT JOIN
- `orderByDesc/Asc(field)` - æ’åº
- `limit(value)` / `offset(value)` - åˆ†é¡µ
- `buildSelect(fields)` - æ„å»º SELECT
- `buildCount()` - æ„å»º COUNT
- `clone()` - å…‹éš†æ„å»ºå™¨

## æµ‹è¯•ç»“æœ

### å•å…ƒæµ‹è¯•ï¼ˆqueryBuilder.test.jsï¼‰
âœ… åŸºæœ¬ SELECT æŸ¥è¯¢  
âœ… å¸¦ JOIN çš„æŸ¥è¯¢  
âœ… å¤šæ¡ä»¶æŸ¥è¯¢  
âœ… åˆ†é¡µæŸ¥è¯¢  
âœ… COUNT æŸ¥è¯¢  
âœ… å‚æ•°éš”ç¦»éªŒè¯  
âœ… WHERE IN æŸ¥è¯¢  
âœ… å…‹éš†æŸ¥è¯¢æ„å»ºå™¨  

### é›†æˆæµ‹è¯•ï¼ˆçœŸå®æ•°æ®åº“ï¼‰
âœ… æŸ¥è¯¢æŠ¥ä»·å•åˆ—è¡¨  
âœ… å¸¦æ¡ä»¶çš„æŸ¥è¯¢  
âœ… COUNT æŸ¥è¯¢  
âœ… å¤šæ¬¡è°ƒç”¨éªŒè¯  

## å½±å“èŒƒå›´

### ä¿®æ”¹çš„æ–‡ä»¶
- `backend/models/Quotation.js` - é‡æ„ findAll æ–¹æ³•

### æ–°å¢çš„æ–‡ä»¶
- `backend/utils/queryBuilder.js` - æŸ¥è¯¢æ„å»ºå™¨
- `backend/utils/queryBuilder.test.js` - å•å…ƒæµ‹è¯•
- `docs/é—®é¢˜4ä¿®æ­£-SQLæŸ¥è¯¢æ„å»ºå™¨.md` - è¯¦ç»†æ–‡æ¡£

### æœªä¿®æ”¹çš„æ–‡ä»¶
- å…¶ä»–æ¨¡å‹æ–‡ä»¶ï¼ˆMaterial.jsã€User.js ç­‰ï¼‰æš‚æœªä½¿ç”¨æŸ¥è¯¢æ„å»ºå™¨
- æ§åˆ¶å™¨æ–‡ä»¶ä¿æŒä¸å˜
- å‰ç«¯ä»£ç ä¸å—å½±å“

## åç»­å»ºè®®

1. **é€æ­¥è¿ç§»**ï¼šåœ¨æ–°å¢å¤æ‚æŸ¥è¯¢æ—¶ä¼˜å…ˆä½¿ç”¨ QueryBuilder
2. **æ‰©å±•åŠŸèƒ½**ï¼šæ ¹æ®éœ€è¦æ·»åŠ æ›´å¤šæŸ¥è¯¢æ–¹æ³•ï¼ˆå¦‚ groupByã€having ç­‰ï¼‰
3. **ä»£ç å®¡æŸ¥**ï¼šç¡®ä¿æ–°ä»£ç éµå¾ªæŸ¥è¯¢æ„å»ºå™¨çš„ä½¿ç”¨è§„èŒƒ
4. **æ€§èƒ½ç›‘æ§**ï¼šè§‚å¯ŸæŸ¥è¯¢æ€§èƒ½ï¼Œå¿…è¦æ—¶æ·»åŠ ç´¢å¼•ä¼˜åŒ–

## æ€»ç»“

é€šè¿‡å¼•å…¥è½»é‡çº§çš„ QueryBuilderï¼ŒæˆåŠŸè§£å†³äº†é—®é¢˜4ï¼ˆSQL æ‹¼æ¥çš„æ½œåœ¨éšæ‚£ï¼‰ï¼Œæå‡äº†ä»£ç è´¨é‡å’Œå®‰å…¨æ€§ã€‚è¿™æ˜¯ä¸€ä¸ªä½æˆæœ¬ã€é«˜æ”¶ç›Šçš„é‡æ„ï¼Œä¸ºé¡¹ç›®çš„é•¿æœŸç»´æŠ¤å¥ å®šäº†è‰¯å¥½åŸºç¡€ã€‚

**å…³é”®æˆæœ**ï¼š
- ğŸ¯ æ¶ˆé™¤äº† SQL æ³¨å…¥é£é™©
- ğŸ¯ æé«˜äº†ä»£ç å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§
- ğŸ¯ ç»Ÿä¸€äº†æŸ¥è¯¢æ„å»ºé€»è¾‘
- ğŸ¯ é€šè¿‡äº†å®Œæ•´çš„æµ‹è¯•éªŒè¯
- ğŸ¯ ä¿æŒäº†å‘åå…¼å®¹æ€§
