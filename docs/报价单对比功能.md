# 报价单对比功能实现说明

## 功能概述

实现了报价单对比功能，允许用户在报价单列表中选择2-4个报价单进行并排对比，直观地查看不同包装配置的成本差异。

## 使用场景

当同一型号（如9500）有多个包装配置（如不带气阀、带气阀）时，用户可以：
1. 在报价单列表中勾选需要对比的报价单
2. 点击"对比模式"按钮
3. 在对比页面查看各配置的详细成本明细和差异分析

## 功能特点

### 1. 报价单选择
- 在报价单列表左侧增加复选框
- 只允许选择已提交或已审核状态的报价单
- 支持选择2-4个报价单进行对比
- 实时显示已选择的报价单数量

### 2. 对比展示
- **分栏布局**：每个报价单占一列，并排展示
- **配置信息**：显示报价单号、包装配置、数量、状态
- **原料明细**：列出所有原料及其用量、单价、小计
- **工序明细**：列出所有工序及其用量、单价、小计
- **包材明细**：列出所有包材及其用量、单价、小计
- **成本计算**：显示运费成本、基础成本、管销价、最终价格

### 3. 差异分析
- 自动计算各项成本差异（原料、工序、包材）
- 计算最终价格差异（绝对值和百分比）
- 智能生成差异摘要，指出主要差异来源
- 使用统计卡片直观展示差异数据

### 4. 导出功能
- 支持打印对比报告
- 预留导出Excel功能接口

## 技术实现

### 前端改动

#### 1. CostRecords.vue（报价单列表）
- 添加复选框列（`el-table-column type="selection"`）
- 添加"对比模式"按钮，显示已选数量
- 实现选择逻辑和可选择性判断
- 跳转到对比页面并传递报价单ID

#### 2. CostCompare.vue（对比页面）
- 新建独立的对比页面组件
- 实现分栏布局（使用 `el-col` 动态分配列宽）
- 并发加载多个报价单详情
- 实现差异分析算法
- 响应式设计，支持2-4列对比

#### 3. router/index.js（路由配置）
- 添加 `/cost/compare` 路由
- 配置需要认证访问

### 后端接口

复用现有接口，无需新增：
- `GET /api/cost/quotations/:id` - 获取报价单详情
- 前端通过 `Promise.all` 并发请求多个报价单

### 数据流程

```
报价单列表页
  ↓ 用户勾选2-4个报价单
  ↓ 点击"对比模式"
对比页面
  ↓ 解析URL参数（ids=1,2,3）
  ↓ 并发请求报价单详情
  ↓ 组织数据结构
  ↓ 渲染分栏对比
  ↓ 计算差异分析
展示结果
```

## 使用说明

### 操作步骤

1. **进入报价单列表**
   - 导航到"报价单记录"页面

2. **选择报价单**
   - 勾选需要对比的报价单（2-4个）
   - 只能选择已提交或已审核状态的报价单
   - 顶部按钮会显示已选数量

3. **进入对比模式**
   - 点击"对比模式"按钮
   - 系统自动跳转到对比页面

4. **查看对比结果**
   - 查看各配置的详细明细
   - 查看差异分析结果
   - 可打印或导出报告

### 注意事项

- 建议对比同一客户、同一型号的报价单，以获得更准确的对比结果
- 如果选择了不同客户或型号的报价单，系统会给出提示
- 对比页面为只读模式，不支持编辑
- 最多同时对比4个报价单，以保证页面可读性

## 差异分析算法

### 计算逻辑

1. **成本项差异**
   ```javascript
   差异 = 最后一个配置的成本 - 第一个配置的成本
   ```

2. **百分比差异**
   ```javascript
   百分比 = (差异 / 第一个配置的成本) × 100%
   ```

3. **主要差异来源**
   - 比较原料、工序、包材的差异绝对值
   - 按差异大小排序
   - 在摘要中指出最大的1-2项差异

### 摘要生成

格式：`配置X比配置Y贵/便宜 XX元 (XX%)，主要差异在原料和工序`

示例：
- "配置'带气阀'比配置'不带气阀'贵 0.34 CNY (17.3%)，主要差异在工序和包材"
- "配置'标准'比配置'加强'便宜 0.15 CNY (8.5%)，主要差异在包材"

## 扩展建议

### 短期优化
1. 实现Excel导出功能
2. 添加图表对比（柱状图、饼图）
3. 支持自定义对比项（只对比某些明细）

### 长期规划
1. 支持历史对比（同一配置不同时间的价格变化）
2. 支持跨客户对比（相同型号不同客户的报价）
3. 添加对比模板保存功能
4. 生成对比分析报告（PDF）

## 测试建议

### 功能测试
- [ ] 选择2个报价单对比
- [ ] 选择3个报价单对比
- [ ] 选择4个报价单对比
- [ ] 尝试选择超过4个（应提示错误）
- [ ] 尝试选择少于2个（按钮应禁用）
- [ ] 选择不同客户的报价单（应有提示）
- [ ] 选择不同型号的报价单（应有提示）

### 界面测试
- [ ] 2列布局显示正常
- [ ] 3列布局显示正常
- [ ] 4列布局显示正常
- [ ] 差异分析计算正确
- [ ] 打印功能正常
- [ ] 响应式布局适配

### 性能测试
- [ ] 并发加载4个报价单的响应时间
- [ ] 大量明细数据的渲染性能
- [ ] 页面滚动流畅度

## 更新日志

### 2025-01-XX
- ✅ 实现报价单列表复选框功能
- ✅ 实现对比模式按钮和跳转
- ✅ 创建对比页面组件
- ✅ 实现分栏对比布局
- ✅ 实现差异分析算法
- ✅ 添加路由配置
- ✅ 完成基础功能开发

## 相关文件

### 前端
- `frontend/src/views/cost/CostRecords.vue` - 报价单列表（已修改）
- `frontend/src/views/cost/CostCompare.vue` - 对比页面（新增）
- `frontend/src/router/index.js` - 路由配置（已修改）

### 后端
- 无需修改，复用现有接口

### 文档
- `docs/报价单对比功能.md` - 本文档
