# 更新说明：自定义利润栏位

## 更新日期
2025-11-10

## 更新内容

### 功能概述

在报价单新增页面和报价单详情页面的"利润区间报价"下方，新增"自定义利润"栏位，允许用户自行输入利润百分比，系统自动计算并显示对应的报价。

### 界面位置

**位置：** 利润区间报价表格下方

**页面：**
- 报价单新增页面（`/cost/add`）
- 报价单详情页面（`/cost/detail/:id`）

### 功能说明

#### 1. 输入栏位

- **标签：** 利润率
- **输入类型：** 普通文本输入框（数字类型）
- **取值范围：** 0 到 10（即 0% 到 1000%）
- **占位符：** "请输入利润率（如：0.35 表示 35%）"
- **特点：** 无步进器，支持直接输入任意数字

#### 2. 计算逻辑

**计算公式：**
```
自定义利润报价 = 基础价格 × (1 + 利润率)
```

**基础价格说明：**
- **内销**：使用内销价（domesticPrice）
- **外销**：使用保险价（insurancePrice）

**示例（外销）：**
- 基础价格（保险价）：$15.00
- 利润率：0.35（35%）
- 自定义利润报价：$15.00 × (1 + 0.35) = $20.25

**示例（内销）：**
- 基础价格（内销价）：¥141.25
- 利润率：0.20（20%）
- 自定义利润报价：¥141.25 × (1 + 0.20) = ¥169.50

#### 3. 显示效果

- 输入利润率后，实时计算并显示报价
- 报价以绿色高亮显示，便于识别
- 显示格式：`报价：$20.25 CNY`（根据销售类型显示对应货币）

### 界面示例

```
┌─────────────────────────────────────────────────┐
│ 利润区间报价                                    │
├─────────────────────────────────────────────────┤
│ 利润率    │ 报价          │ 说明                │
│ 5%        │ $15.75 CNY    │ 在基础价格上增加... │
│ 10%       │ $16.50 CNY    │ 在基础价格上增加... │
│ 25%       │ $18.75 CNY    │ 在基础价格上增加... │
│ 50%       │ $22.50 CNY    │ 在基础价格上增加... │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ 自定义利润                                      │
├─────────────────────────────────────────────────┤
│ 利润率：[  0.35  ] (0-1000%)                   │
│         报价：$20.25 CNY                        │
└─────────────────────────────────────────────────┘
```

### 使用步骤

#### 在报价单新增页面

1. 填写基本信息（法规类别、型号配置、客户信息等）
2. 填写数量
3. 点击"计算成本"按钮
4. 查看利润区间报价表格
5. 在"自定义利润"栏位输入利润率（例如：0.35）
6. 系统自动计算并显示报价

#### 在报价单详情页面

1. 打开报价单详情
2. 查看利润区间报价表格
3. 在"自定义利润"栏位输入利润率
4. 系统自动计算并显示报价

### 特点

1. **实时计算**：输入利润率后立即显示报价
2. **灵活性高**：不受系统配置的利润区间限制
3. **范围广泛**：支持 0% 到 1000% 的利润率
4. **精确控制**：支持任意小数位精度
5. **清晰显示**：报价以绿色高亮，易于识别
6. **无步进器**：使用普通输入框，输入更自由

### 注意事项

1. **前置条件**：必须先完成成本计算，才能使用自定义利润功能
2. **基础价格**：自定义利润基于"基础价格"计算
3. **货币单位**：报价货币根据销售类型自动显示（内销：CNY，外销：USD）
4. **不预设数字**：利润率输入框默认为空，由用户自行填写
5. **独立计算**：自定义利润与系统配置的利润区间独立，互不影响

### 技术实现

#### 前端实现

**文件：**
- `frontend/src/views/cost/CostAdd.vue`
- `frontend/src/views/cost/CostDetail.vue`

**核心代码：**

```javascript
// 自定义利润
const customProfitRate = ref(null)
const customProfitPrice = ref(null)

// 计算自定义利润
const calculateCustomProfit = () => {
  // 清空结果
  customProfitPrice.value = null
  
  // 验证输入
  if (customProfitRate.value === null || customProfitRate.value === undefined || customProfitRate.value === '') {
    return
  }
  
  // 验证计算结果是否存在
  if (!calculation.value) {
    return
  }
  
  // 获取基础价格（根据销售类型）
  let basePrice
  if (calculation.value.salesType === 'domestic') {
    // 内销：使用内销价
    basePrice = calculation.value.domesticPrice
  } else if (calculation.value.salesType === 'export') {
    // 外销：使用保险价
    basePrice = calculation.value.insurancePrice
  }
  
  if (!basePrice) {
    return
  }
  
  // 转换为数字
  const rate = parseFloat(customProfitRate.value)
  
  // 验证是否为有效数字
  if (isNaN(rate)) {
    return
  }
  
  // 验证范围（0-10，即0%-1000%）
  if (rate < 0 || rate > 10) {
    ElMessage.warning('利润率范围应在 0-10 之间（0%-1000%）')
    return
  }
  
  // 计算自定义利润价格：基础价格 × (1 + 利润率)
  customProfitPrice.value = basePrice * (1 + rate)
}
```

**模板代码：**

```vue
<div class="custom-profit-section">
  <h4>自定义利润</h4>
  <div class="custom-profit-input">
    <span class="label">利润率：</span>
    <el-input
      v-model.number="customProfitRate"
      type="number"
      placeholder="请输入利润率（如：0.35 表示 35%）"
      style="width: 280px"
      @input="calculateCustomProfit"
      clearable
    />
    <span class="unit">（0-1000%）</span>
    <span class="result" v-if="customProfitPrice !== null">
      报价：<strong>{{ formatNumber(customProfitPrice) }} {{ calculation.currency }}</strong>
    </span>
  </div>
</div>
```

### 样式设计

- **背景色**：浅灰色（#f5f7fa），与利润区间表格区分
- **边距**：上方24px，与表格保持适当间距
- **内边距**：16px，内容不拥挤
- **圆角**：4px，与系统整体风格一致
- **报价颜色**：绿色（#67c23a），突出显示

### 使用场景

1. **特殊客户报价**：针对特定客户需要特殊利润率
2. **市场测试**：测试不同利润率下的市场接受度
3. **快速报价**：快速计算任意利润率的报价
4. **灵活定价**：不受系统预设利润区间限制

### 示例场景

#### 场景1：常规利润率

- 基础价格：$15.00
- 利润率：0.20（20%）
- 报价：$15.00 × 1.20 = $18.00

#### 场景2：高利润率

- 基础价格：$15.00
- 利润率：0.80（80%）
- 报价：$15.00 × 1.80 = $27.00

#### 场景3：低利润率

- 基础价格：$15.00
- 利润率：0.05（5%）
- 报价：$15.00 × 1.05 = $15.75

#### 场景4：极高利润率

- 基础价格：$15.00
- 利润率：2.00（200%）
- 报价：$15.00 × 3.00 = $45.00

### 与利润区间的区别

| 特性 | 利润区间报价 | 自定义利润 |
|------|-------------|-----------|
| **数据来源** | 系统配置 | 用户输入 |
| **数量** | 固定（默认4个） | 1个 |
| **利润率** | 预设（5%, 10%, 25%, 50%） | 任意（0-1000%） |
| **修改方式** | 系统配置管理 | 直接输入 |
| **显示方式** | 表格 | 单行输入 |
| **用途** | 标准报价参考 | 灵活定制报价 |

### 优势

1. **灵活性**：不受系统预设利润区间限制
2. **即时性**：输入后立即显示结果
3. **直观性**：清晰显示计算结果
4. **独立性**：不影响系统配置的利润区间
5. **易用性**：简单直观的输入界面

### 常见问题

#### Q1：自定义利润和利润区间有什么区别？

A：利润区间是系统预设的固定利润率（如5%, 10%, 25%, 50%），自定义利润允许用户输入任意利润率（0-1000%）。

#### Q2：为什么我输入利润率后没有显示报价？

A：请确保已经完成成本计算。只有在成本计算完成后，才能使用自定义利润功能。

#### Q3：自定义利润的最大值是多少？

A：最大值是10，即1000%的利润率。

#### Q4：可以输入负数吗？

A：不可以。利润率的最小值是0。

#### Q5：自定义利润会保存到报价单吗？

A：不会。自定义利润仅用于临时计算和参考，不会保存到报价单中。

#### Q6：如何清除自定义利润？

A：点击输入框右侧的清除按钮（×）或手动清空输入框即可。

#### Q7：为什么输入大于10的数字会提示错误？

A：利润率的最大值是10（即1000%）。如果需要更高的利润率，请联系管理员调整系统限制。

#### Q8：可以输入小数吗？

A：可以。支持任意小数位精度，例如：0.35、0.123、1.5 等。

### 更新日志

- **2025-11-10**：新增自定义利润栏位功能

### 相关文件

- 报价单新增页面：`frontend/src/views/cost/CostAdd.vue`
- 报价单详情页面：`frontend/src/views/cost/CostDetail.vue`
- 更新说明：`docs/更新-自定义利润栏位.md`
