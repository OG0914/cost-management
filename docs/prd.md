# 📘 成本分析管理系统 PRD（修正版）

## 1️⃣ 项目概述

### 🎯 项目目标

构建一个**轻量级、可扩展、低维护成本**的网页版成本分析管理系统，取代目前依赖Excel的人工审核流程。
通过固定计算公式、标准化原料/工价数据、自动生成多档利润报价，显著减少审核人工作量，并统一计算逻辑。

---

## 2️⃣ 技术栈与开发框架

| 层级     | 技术栈                                                          | 用途                                |
| -------- | --------------------------------------------------------------- | ----------------------------------- |
| 前端     | **Vue3 + Element Plus + TailwindCSS + Axios + Pinia + Vue Router** | 表单输入、数据绑定、表格展示与交互 |
| 后端     | **Node.js + Express + bcrypt + jsonwebtoken + multer**          | API服务、计算逻辑、用户与权限控制   |
| 数据库   | **PostgreSQL (pg驱动 + 连接池)**                                | 生产级数据库，支持高并发访问        |
| 报表导出 | **ExcelJS**                                                     | 报价单导出（复刻原Excel表样式）     |

---

## 3️⃣ 系统核心逻辑

### 3.1 成本计算公式

| 项目         | 计算公式                    | 说明                      |
| ------------ | --------------------------- | ------------------------- |
| 成本价       | 原料总价 + 工价总价 + 包材总价 + 运费成本 | 自动汇总              |
| 管销价       | 成本价 ÷ (1 - 管销率)       | 默认管销率 20%（即 ÷0.8） |
| 内销价（含税）| 管销价 × (1 + 增值税率)     | 增值税率可配置，默认13%   |
| 外销价（未税）| 管销价 ÷ 汇率               | 汇率系统配置              |
| 外销保险价   | 外销价 × (1 + 保险率)       | 保险率0.3%                |
| 利润区间报价 | 基础价 × (1 + 利润%)        | 自动生成多档：5%、10%、25%、50% |

### 3.2 运费计算（外销）

| 运输方式     | 计算逻辑                                    |
| ------------ | ------------------------------------------- |
| 20尺整柜 FCL | 固定运费（美金）× 汇率 ÷ 数量               |
| 40尺整柜 FCL | 固定运费（美金）× 汇率 ÷ 数量               |
| 散货 LCL     | (基础运费 + 操作费 + 拼箱费×CBM + 文件费) ÷ 数量 |

### 3.3 原料系数

不同产品类别应用不同的原料系数：
- 口罩：0.97
- 半面罩：0.99

---

## 4️⃣ 系统模块设计

### 4.1 法规与型号模块 ✅ 已实现

* **法规类别维护**
  * 示例：口罩（NIOSH、GB、CE、ASNZS）、半面罩（NIOSH、GB、CE）
  * 管理员可新增、禁用、编辑法规类别

* **型号维护**
  * 型号绑定法规类别
  * 每个型号可配置多个包装方式
  * 由管理员导入或新增

---

### 4.2 原物料模块 ✅ 已实现

* **数据来源**：采购人员导入Excel
* **内容字段**：`料号 | 原料名称 | 单位 | 单价 | 币别 | 厂商 | 用量`
* **用途**：
  * 新增报价单时，系统自动匹配对应原料单价
  * 支持价格追溯（记录历史价格变化）

---

### 4.3 工序模块 ✅ 已实现

* **数据结构**：工序配置关联到包装配置
* **字段**：`工序名称 | 单价 | 排序`
* **特点**：
  * 每个包装配置可有不同的工序列表
  * 支持排序和启用/禁用

---

### 4.4 包材模块 ✅ 已实现

* **数据结构**：
  * 包装配置表（packaging_configs）：型号 + 包装方式组合
  * 包材明细表（packaging_materials）：关联包装配置的包材列表
* **字段**：
  * 包装配置：`型号 | 配置名称 | 每袋数量 | 每盒袋数 | 每箱盒数`
  * 包材明细：`包材名称 | 基础用量 | 单价 | 箱体积`

---

### 4.5 成本分析与报价模块 ✅ 已实现

#### 🧾 流程：

1. 业务点击「新增报价单」
2. 选择法规类别 → 型号 → 包装配置 → 内/外销
3. 系统自动带出对应原料、工序、包材、用量与价格
4. 业务填写：
   * 客户名称
   * 购买数量
   * 客户地区
   * 运输方式（外销时）
   * 运费信息

#### 🧮 系统自动计算：

```
成本价 = (原料 × 原料系数) + 工价 + 包材 + 运费
管销价 = 成本价 ÷ (1 - 管销率)
内销价 = 管销价 × (1 + 增值税率)
外销价 = 管销价 ÷ 汇率
保险价 = 外销价 × (1 + 保险率)
利润区间报价 = 基础价 × (1 + 利润%)
```

#### 💡 扩展功能：

* **标准成本管理**：设定包装配置的标准成本基准
* **成本比较**：对比不同报价单的成本差异
* **自定义费用**：支持在管销价后添加额外费用项
* **自定义增值税率**：单个报价单可覆盖系统默认税率

---

### 4.6 报价单导出模块 🚧 待开发

* 报价单导出支持 **XLSX**（PDF待开发）
* 模板复刻Excel格式：
  * 表头含客户信息、型号、法规类别
  * 表体分区：原料 / 工价 / 包材
  * 尾部为自动生成的利润区间报价表
* 导出保留格式颜色与单元格合并
* 审核人、生成时间自动写入

---

### 4.7 审核模块 ✅ 已实现

* **状态流转**：草稿 → 已提交 → 已审核/已退回 → 可重新提交
* **待审核记录页面**：审核人查看已提交的报价单列表，支持筛选和分页
* **已审核记录页面**：查看已通过或已退回的报价单，支持状态筛选
* **审核操作**：
  * 通过：添加批注，记录审核人ID和时间
  * 退回：填写退回原因，记录审核人ID和时间
* **差异高亮**：业务员修改的明细项使用浅蓝色高亮显示，新增项使用浅绿色
* **审核历史**：完整的时间线追溯（创建→提交→审核/退回）
* **权限控制**：管理员/审核人可访问，业务员/只读用户无权限
* **业务员操作**：
  * 查看被退回的报价单及退回原因
  * 编辑已退回的报价单
  * 重新提交报价单

---

### 4.8 后端分页优化 ✅ 已实现

* **全量数据优化**：所有列表页面采用后端分页，避免一次性加载大量数据
* **搜索功能**：支持关键词模糊搜索（客户名称、型号、报价单编号等）
* **防抖优化**：搜索输入300ms防抖，减少无效请求
* **分页参数**：支持自定义页码和每页条数（默认20条，最大100条）
* **排序支持**：按创建时间、提交时间、审核时间等字段排序
* **响应式加载**：数据加载时显示loading状态

---

### 4.9 高级功能 ✅ 已实现

#### 卡片/列表视图切换
* **包材管理**：支持卡片视图和列表视图切换，卡片视图展示包装配置详情
* **工序管理**：支持卡片视图和列表视图切换，卡片视图展示工序配置详情
* **默认视图**：卡片视图为默认展示方式
* **响应式布局**：不同屏幕尺寸自动调整卡片数量（1-4列）
* **批量操作**：仅列表视图支持批量操作

#### 管销后自定义费用
* **累乘计算**：支持在管销价后添加多个自定义费用，按顺序累乘计算
* **费用管理**：可添加、删除费用项，包含费用名称和费率
* **总结金额**：自动计算所有费用累乘后的总结金额
* **保存和加载**：自定义费用配置随报价单保存和加载

#### 自定义增值税率覆盖
* **报价单级别覆盖**：单个报价单可使用自定义增值税率，不影响全局配置
* **税率验证**：支持0-1之间的税率值，默认使用全局配置
* **内销外销区分**：仅内销报价单显示增值税率选项
* **复制继承**：复制报价单时继承原报价单的增值税率

#### 产品BOM管理
* **型号级别BOM**：每个型号可配置标准原料清单
* **用量管理**：记录每个原料的标准用量
* **激活状态**：支持启用/禁用BOM项
* **排序支持**：自定义BOM项显示顺序

---

### 4.10 报表导出模块 🚧 待开发

* 状态流转：草稿 → 已提交 → 已审核/已退回
* 差异高亮显示
* 批注功能
* 审核记录追溯

---

## 5️⃣ 用户与权限设计 ✅ 已实现

| 角色           | 权限说明                           |
| -------------- | ---------------------------------- |
| **管理员**     | 全权限（法规、型号、包材维护、用户管理） |
| **采购**       | 导入/导出原料单价                  |
| **生产**       | 导入/导出工价                      |
| **审核人（K）**| 审核、批注、导出、查看差异高亮     |
| **业务员**     | 增查删改提交报价单                 |
| **只读账号**   | 仅查看与导出                       |

---

## 6️⃣ 界面设计要点

| 页面       | 关键功能                  | 状态     |
| ---------- | ------------------------- | -------- |
| 登录页     | 用户认证、角色识别        | ✅ 已实现 |
| 仪表盘     | 导航入口                  | ✅ 已实现 |
| 报价管理页 | 类Excel表格、实时计算     | ✅ 已实现 |
| 审核页     | 差异比对、高亮显示        | 🚧 待开发 |
| 导出页     | 报价单预览、XLSX/PDF导出  | 🚧 待开发 |

---

## 7️⃣ 数据表设计

### 核心表结构

| 表名                   | 描述                 | 状态     |
| ---------------------- | -------------------- | -------- |
| users                  | 用户表               | ✅ 已实现 |
| regulations            | 法规类别表           | ✅ 已实现 |
| models                 | 型号表               | ✅ 已实现 |
| materials              | 原料表               | ✅ 已实现 |
| packaging_configs      | 包装配置表           | ✅ 已实现 |
| packaging_materials    | 包材明细表           | ✅ 已实现 |
| process_configs        | 工序配置表           | ✅ 已实现 |
| quotations             | 报价单主表           | ✅ 已实现 |
| quotation_items        | 报价单明细表         | ✅ 已实现 |
| quotation_custom_fees  | 报价单自定义费用表   | ✅ 已实现 |
| standard_costs         | 标准成本表           | ✅ 已实现 |
| system_config          | 系统配置表           | ✅ 已实现 |
| comments               | 批注表               | ✅ 已实现 |
| model_bom_materials    | 产品BOM表            | ✅ 已实现 |
| price_history          | 价格历史表           | ✅ 已实现 |
| migrations             | 迁移记录表           | ✅ 已实现 |

---

## 8️⃣ 审核机制与颜色规则 ✅ 已实现

| 状态     | 表示              | 说明           |
| -------- | ----------------- | -------------- |
| 默认     | 白色              | 标准配置项     |
| 修改后   | 浅蓝              | 业务员修改的栏位 |
| 审核通过 | 绿色边框          | 审核人确认通过 |
| 审核退回 | 红色边框 + 备注气泡 | 审核驳回原因   |

---

## 9️⃣ 导入导出标准

| 模块     | 导入/导出格式                       | 状态     |
| -------- | ----------------------------------- | -------- |
| 原料导入 | `.xlsx` 文件                        | ✅ 已实现 |
| 工价导入 | `.xlsx` 文件                        | ✅ 已实现 |
| 报价导出 | `.xlsx`（后端生成器已实现）        | ✅ 已实现 |
| PDF导出  | `.pdf`                              | 🚧 待开发 |

---

## 🔧 10️⃣ 系统配置项 ✅ 已实现

| 配置项                | 默认值                   | 说明                |
| --------------------- | ------------------------ | ------------------- |
| overhead_rate         | 0.2                      | 管销率              |
| vat_rate              | 0.13                     | 增值税率            |
| insurance_rate        | 0.003                    | 保险率              |
| exchange_rate         | 7.2                      | 汇率（CNY/USD）     |
| profit_tiers          | [0.05, 0.10, 0.25, 0.50] | 利润区间            |
| fob_shenzhen_exchange_rate | 7.1                 | FOB深圳运费汇率     |
| fcl_20_freight_usd    | 840                      | 20尺整柜运费（美金）|
| fcl_40_freight_usd    | 940                      | 40尺整柜运费（美金）|
| lcl_base_freight_*    | 800/1000/1500            | 散货基础运费        |
| lcl_handling_charge   | 500                      | 散货操作费          |
| lcl_cfs_per_cbm       | 170                      | 散货拼箱费/CBM      |
| lcl_document_fee      | 500                      | 散货文件费          |
| material_coefficients | {"口罩": 0.97, "半面罩": 0.99} | 原料系数配置  |

---

## 11️⃣ 开发原则与架构

### ✅ 编码原则

1. **模块化结构**：前后端代码分离，前端 Vue 组件粒度控制在单页功能级
2. **数据驱动**：所有价格、汇率、公式参数均来源数据库
3. **轻量无依赖**：仅使用必要依赖，适配内网部署
4. **可维护性优先**：注释清晰、结构统一
5. **防呆逻辑**：前端锁定公式栏，防止误操作
6. **一致性设计**：所有数值计算在后端完成

---

## 12️⃣ 部署方式

* **运行环境**：Windows Server / Node.js v18+
* **数据库文件**：`backend/db/cost_analysis.db`
* **启动命令**：

  ```bash
  # 后端
  cd backend
  npm install
  npm start

  # 前端
  cd frontend
  npm install
  npm run dev
  ```

* **访问路径**：
  * 前端：`http://localhost:5173`
  * 后端API：`http://localhost:3000`

---

## 13️⃣ 开发进度

### ✅ 已完成

- 用户认证与权限管理
- 法规类别管理
- 型号管理
- 原料管理（含Excel导入）
- 包装配置与包材管理（卡片/列表视图切换）
- 工序配置管理（卡片/列表视图切换）
- 成本分析与报价（核心功能）
- 标准成本管理
- 成本比较功能
- 系统配置管理
- 自定义费用支持（管销后累乘计算）
- 自定义增值税率覆盖（报价单级别）
- 审核流程（状态流转、批注、差异高亮、待审核/已审核页面）
- 产品BOM管理（型号级别原料清单）
- 后端分页（全量数据高效查询）

### 🚧 待开发

- 报表导出页面
- PDF导出支持
- 仪表盘统计图表（报价次数、审核时长、成本趋势）
